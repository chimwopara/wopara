<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>Blob</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            min-height: 100vh;
            background: transparent;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            padding-top: 20px;
            padding-right: 20px;
        }

        .phone-container {
            position: relative;
            width: 650px;
            height: 650px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 80px;
            filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.2));
            animation: float 6s ease-in-out infinite;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible;
        }

        .phone-container.music-bg {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 20%, #fd79a8 40%, #fdcb6e 60%, #6c5ce7 80%, #a29bfe 100%);
            background-size: 300% 300%;
            animation: float 6s ease-in-out infinite, musicBackgroundFlow 8s ease-in-out infinite;
        }

        @keyframes musicBackgroundFlow {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 0%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        .phone-container.settings-stretched {
            height: 1000px;
            border-radius: 475px;
            padding: 80px 80px 80px 80px;
        }

        .phone-container.buy-stretched {
            height: 1000px;
            border-radius: 850px;
            padding: 80px 80px 100px 80px;
        }

        .phone-container.purchase-effect {
            background: rgba(52, 199, 89, 0.3);
            border: 1px solid rgba(52, 199, 89, 0.5);
            box-shadow: 0 0 50px rgba(52, 199, 89, 0.4);
        }

        .phone-container.remove-effect {
            background: rgba(255, 59, 48, 0.3);
            border: 1px solid rgba(255, 59, 48, 0.5);
            box-shadow: 0 0 50px rgba(255, 59, 48, 0.4);
        }

        .phone-container.gold-effect {
            background: rgba(255, 215, 0, 0.3);
            border: 1px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.4);
        }

        .phone-container.blue-effect {
            background: rgba(0, 191, 255, 0.3);
            border: 1px solid rgba(0, 191, 255, 0.5);
            box-shadow: 0 0 50px rgba(0, 191, 255, 0.4);
        }

        .phone-container.purple-effect {
            background: rgba(175, 82, 222, 0.3);
            border: 1px solid rgba(175, 82, 222, 0.5);
            box-shadow: 0 0 50px rgba(175, 82, 222, 0.4);
        }

        .phone-container.white-effect {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.4);
        }

        .phone-container.black-effect {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 0, 0, 0.6);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotateX(0deg); }
            50% { transform: translateY(-10px) rotateX(2deg); }
        }

        .screen {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .status-bar {
    position: relative;
    height: 120px;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    margin-bottom: 15px;
    padding-top: 60px;
}



        .curved-text {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 450px;
            height: 80px;
        }

        .curved-text svg {
            width: 100%;
            height: 100%;
        }

        .curved-text text {
            fill: white;
            font-size: 15px;
            font-weight: 500;
            opacity: 0.9;
            text-anchor: middle;
        }

        .apps-grid {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 550px;
            height: 180px;
            overflow: visible;
        }

        .app {
            position: absolute;
            width: 120px;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: visible;
            background: none;
            border: none;
            outline: none;
        }

.Pals {
    bottom: -90px;
    left: 215px;
    transform: rotate(0deg);
}

        

.Notes {
    bottom: -50px;
    left: 70px;
    transform: rotate(0deg);
}

.Carts {
    bottom: -50px;
    right: 70px;
    transform: rotate(0deg);
}

        .Pals:hover { transform: translateY(-5px) scale(1.05); }
       
        .Notes:hover { transform: translateY(-5px) scale(1.05); }
        .Carts:hover { transform: translateY(-5px) scale(1.05); }

        .Pals:active { transform: translateY(-2px) scale(0.98); }
        
        .Notes:active { transform: translateY(-2px) scale(0.98); }
        .Carts:active { transform: translateY(-2px) scale(0.98); }

        .app-icon {
            width: 70px;
            height: 70px;
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            margin-bottom: 8px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            border: none;
            outline: none;
        }

        .app-name {
    font-size: 11px;
    color: white;
    font-weight: 500;
    text-align: center;
    opacity: 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    transform: rotate(0deg);
    transition: opacity 0.3s ease;
}

.app:hover .app-name {
    opacity: 0.95;
}

        .Pals .app-icon { background-image: url('../../../assets/blob/fsPals.png'); }
        
        .Carts .app-icon { background-image: url('../../../assets/blob/fsBank.png'); }
        
        .Notes .app-icon { background-image: url('../../../assets/blob/notesicon.png'); }

        .media-player {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, rgba(106, 90, 205, 0.8), rgba(180, 160, 220, 0.6));
            background-size: 105% 105%;
            background-position: center;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
            position: relative;
        }

        /* New curved track title inside media player */
        .track-title-curved {
    display: none;
}

        .track-title-curved svg {
            width: 100%;
            height: 100%;
        }

        .track-title-curved text {
            fill: white;
            font-size: 14px;
            font-weight: 600;
            text-anchor: middle;
            opacity: 0.9;
        }



        /* External media controls positioned on sides of the circle */
        .external-media-controls {
    display: none;
}

        .control-btn-external {
            position: absolute;
            width: 16px;
            height: 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 14px;
            pointer-events: all;
            outline: none;
        }

        .control-btn-external.prev {
            left: 55px;
        }

        .control-btn-external.next {
            right: 55px;
        }

        .control-btn-external:hover {
            transform: translateY(-2px) scale(1.1);
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .control-btn-external:active {
            transform: translateY(0px) scale(0.95);
        }

       .progress-slider {
position: absolute;
bottom: -40px;
left: 50%;
transform: translateX(-50%);
width: 200px;
height: 100px;
z-index: 100;
cursor: pointer;
}

        .progress-slider svg {
            width: 100%;
            height: 100%;
            transform: rotate(0deg);
        }

        .progress-track {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 4;
            stroke-linecap: round;
        }

        .progress-fill {
            fill: none;
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.2));
        }

        .volume-slider {
            position: absolute;
            top: 60px;
            left: -40px;
            width: 50px;
            height: 200px;
            z-index: 100;
            cursor: pointer;
        }

        .volume-slider svg {
            width: 100%;
            height: 100%;
            transform: rotate(20deg);
        }

        .volume-track {
            fill: none;
            stroke: rgba(0, 0, 0, 0.2);
            stroke-width: 12;
            stroke-linecap: round;
        }

        .volume-fill {
            fill: none;
            stroke: white;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.3s ease;
            filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.3));
        }

        .buy-menu-btn {
            position: absolute;
            bottom: 16px;
            left: 16px;
            width: 16px;
            height: 16px;
            border: none !important;
            background: none !important;
            background-color: transparent !important;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            outline: none !important;
            box-shadow: none !important;
            transform-origin: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            opacity: 1;
        }

        .buy-menu-btn svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .buy-menu-btn .star-path {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.9);
            stroke-width: 2;
            stroke-linejoin: round;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
        }

        .buy-menu-btn.favorited .star-path {
            fill: rgba(255, 215, 0, 0.9);
            stroke: #FFD700;
            stroke-width: 2;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.3)) drop-shadow(0 0 8px rgba(255, 215, 0, 0.4));
        }

        .buy-menu-btn.purchased .star-path {
            fill: rgba(52, 199, 89, 0.8);
            stroke: rgba(52, 199, 89, 0.9);
            stroke-width: 2;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.4)) drop-shadow(0 0 8px rgba(52, 199, 89, 0.3));
        }

        .buy-menu-btn.purchased-and-favorited .star-path {
            fill: rgba(255, 215, 0, 0.9);
            stroke: rgba(52, 199, 89, 0.9);
            stroke-width: 2;
            filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.3)) drop-shadow(0 0 8px rgba(255, 215, 0, 0.4)) drop-shadow(0 0 4px rgba(52, 199, 89, 0.3));
        }

        .buy-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .buy-menu-btn:active {
            transform: scale(0.95);
        }

        .buy-menu-btn.collapsed {
            transform: scale(0);
        }

        .buy-menu-btn.expanded {
            transform: scale(1.2);
        }

        .settings-menu-btn {
            position: absolute;
            bottom: 16px;
            right: 16px;
            width: 12px;
            height: 12px;
            border: none !important;
            background: none !important;
            background-color: transparent !important;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            outline: none !important;
            box-shadow: none !important;
            transform-origin: center;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            opacity: 1;
        }

        .settings-menu-btn svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .settings-menu-btn .circle-path {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.9);
            stroke-width: 2;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }

        .settings-menu-btn.active-glow .circle-path {
            fill: rgba(255, 255, 255, 0.2);
            stroke: rgba(255, 255, 255, 1);
            stroke-width: 2;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
        }

        .settings-menu-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .settings-menu-btn:active {
            transform: scale(0.95);
        }

        .settings-menu-btn.collapsed {
            transform: scale(0);
        }

        .settings-menu-btn.expanded {
            transform: scale(1.2);
        }

        .search-btn {
    position: absolute;
    bottom: 285px;
    right: 5px;
    width: 40px;
    height: 40px;
    border: none !important;
    background: none !important;
    background-color: transparent !important;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 100;
    outline: none !important;
    box-shadow: none !important;
    transform-origin: center;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    margin: 0;
    opacity: 1;
}

.search-btn svg {
    width: 100%;
    height: 100%;
    display: block;
}

.search-btn .search-path {
    fill: transparent;
    stroke: rgba(255, 255, 255, 0.9);
    stroke-width: 2;
    stroke-linecap: round;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
}

.search-btn.active-glow .search-path {
    fill: rgba(255, 255, 255, 0.2);
    stroke: rgba(255, 255, 255, 1);
    stroke-width: 2;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
}

.search-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.search-btn:active {
    transform: scale(0.95);
}

.search-btn.collapsed {
    transform: scale(0);
}

.search-btn.expanded {
    transform: scale(1.2);
}

.phone-container.search-mode {
    height: 1200px;
    border-radius: 600px;
    padding: 100px 80px;
}

.phone-container.notes-mode {
    height: calc(100vh - 40px);
    width: 95vw;
    max-width: 1000px;
    max-height: 900px;
    border-radius: 20px;
    padding: 0px;
    top: 20px;
    right: 20px;
}

.phone-container.notes-mode .media-player {
    display: none;
}

.phone-container.notes-mode .curved-text {
    display: none;
}

.phone-container.notes-mode .apps-grid {
    display: none;
}

.phone-container.notes-mode .search-btn {
    display: none;
}

.phone-container.notes-mode .volume-slider {
    display: none;
}

.phone-container.notes-mode .external-media-controls {
    display: none;
}

.notes-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 20px;
    overflow: hidden;
    background: transparent;
    backdrop-filter: blur(20px);
    z-index: 200;
}

.notes-container #notesContent {
    width: 100%;
    height: 100%;
    border-radius: 20px;
    background: transparent;
    overflow: hidden;
}

.notes-container.active {
    opacity: 1;
    pointer-events: all;
}

.phone-container.search-mode .media-player {
    display: none;
}

.phone-container.search-mode .curved-text {
    display: none;
}
/* Disable music effects when in notes mode */
.phone-container.notes-mode.purchase-effect,
.phone-container.notes-mode.remove-effect,
.phone-container.notes-mode.gold-effect,
.phone-container.notes-mode.blue-effect,
.phone-container.notes-mode.purple-effect,
.phone-container.notes-mode.white-effect,
.phone-container.notes-mode.black-effect {
    background: rgba(255, 255, 255, 0.08) !important;
    border: 1px solid rgba(255, 255, 255, 0.15) !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2) !important;
    animation: none !important;
}
.search-container {
    position: absolute;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.search-container.active {
    opacity: 1;
    pointer-events: all;
}

.search-bar {
    width: 100%;
    padding: 20px 25px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50px;
    color: white;
    font-size: 16px;
    outline: none;
    transition: all 0.3s ease;
}

.search-bar::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.search-bar:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.4);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
}

.search-results {
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
    display: none;
}

.search-result-item {
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    margin-bottom: 10px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
}

.search-result-item:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.3);
    transform: scale(1.02);
}

.search-music-btn {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 80px;
    background-size: cover;
    background-position: center;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: white;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
}

.search-music-btn:hover {
    transform: translateX(-50%) scale(1.1);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.search-music-btn:active {
    transform: scale(0.95);
}

.floating-song-bubble {
    position: absolute;
    top: -10px;
    left: 36%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 25px;
    padding: 12px 20px;
    color: white;
    font-size: 12px;
    font-weight: 600;
    opacity: 0;
    pointer-events: none;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    animation: bubbleFloat 5s ease-in-out infinite;
    filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
    white-space: nowrap;
    cursor: pointer;
    z-index: 150;
}

.floating-song-bubble.active {
    opacity: 1;
    pointer-events: all;
}

.floating-song-bubble.hint-blink {
    animation: greenPulse 0.8s ease-in-out;
}

.search-context-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 20px;
            padding: 8px 12px;
            margin-bottom: 12px;
            color: white;
            font-size: 13px;
            backdrop-filter: blur(10px);
        }
        
        .context-text {
            flex: 1;
            font-weight: 500;
        }
        
        .context-remove {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .context-remove:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .context-remove:active {
            transform: scale(0.9);
        }

@keyframes greenPulse {
    0%, 100% { 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    50% { 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 30px rgba(52, 199, 89, 0.9);
        border-color: rgba(52, 199, 89, 0.8);
    }
}

.floating-song-bubble.hint-blink::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: inherit;
    animation: greenBlink 0.8s ease-in-out;
    pointer-events: none;
}
.floating-song-bubble:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.05);
}

.floating-song-bubble.resting {
    animation: none !important;
    transform: translateX(0%) translateY(-5px) !important;
    transition: transform 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
}

.floating-song-bubble.hint-blink {
    animation: greenPulse 0.8s ease-in-out;
}

@keyframes greenPulse {
    0%, 100% { 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    50% { 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), 0 0 30px rgba(52, 199, 89, 0.9);
        border-color: rgba(52, 199, 89, 0.8);
    }
}

@keyframes greenBlink {
    0%, 100% { 
        background: rgba(52, 199, 89, 0);
        box-shadow: none;
    }
    25%, 75% { 
        background: rgba(52, 199, 89, 0.4);
        box-shadow: 0 0 20px rgba(52, 199, 89, 0.6);
    }
    50% { 
        background: rgba(52, 199, 89, 0);
        box-shadow: none;
    }
}

@keyframes bubbleFloat {
    0%, 100% { 
        transform: translateY(-15px) translateX(-15px);
    }
    25% { 
        transform: translateY(-8px) translateX(5px);
    }
    50% { 
        transform: translateY(0px) translateX(-3px);
    }
    75% { 
        transform: translateY(-5px) translateX(8px);
    }
}



        .buy-menu-dropdown {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: rgba(100, 150, 255, 0.15);
            backdrop-filter: blur(25px);
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            width: 280px;
            height: 280px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 101;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transform-origin: center bottom;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 35px;
        }

        .buy-menu-dropdown.active {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) scale(1);
        }

        .settings-menu-dropdown {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: rgba(100, 150, 255, 0.15);
            backdrop-filter: blur(25px);
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 35px;
            width: 360px;
            height: 360px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 101;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transform-origin: center bottom;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
        }

        .settings-menu-dropdown.active {
            opacity: 1;
            pointer-events: all;
            transform: translateX(-50%) scale(1);
        }

.menu-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 10px;
    color: white;
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0;
    justify-content: center;
    width: 80px;
    height: 80px;
    border-radius: 50%;
}

.menu-label {
    font-size: 8px;
    opacity: 0;
    font-weight: 500;
    text-align: center;
    display: block;
    margin-top: 2px;
}

        .menu-item:hover {
background: rgba(255, 255, 255, 0.2);
transform: scale(1.05);
border-color: rgba(255, 255, 255, 0.4);
border-radius: 50%;
}

        .menu-item:active {
            transform: scale(0.98);
        }

        .menu-item .icon {
            font-size: 32px;
            width: 40px;
            text-align: center;
        }

        .menu-item .label {
             display: none;
        }

        .menu-item .price {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 6px 10px;
            min-width: 60px;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .menu-item:hover .price {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .menu-item.active {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

       .menu-separator {
    display: none;
}
        .control-row {
            display: flex;
            gap: 12px;
            justify-content: center;
            width: 100%;
        }

        /* Special styling for buy menu items */
        .buy-menu-dropdown .menu-item {
            max-width: 220px;
            padding: 22px 26px;
            font-size: 15px;
            gap: 18px;
        }

        .buy-menu-dropdown .menu-item .icon {
            font-size: 20px;
            width: 26px;
        }

        .buy-menu-dropdown .menu-item .price {
            padding: 10px 16px;
            font-size: 14px;
            min-width: 80px;
        }

        .control-row .menu-item {
            flex: 1;
            max-width: 110px;
        }

        @keyframes launch {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1.1) rotateZ(5deg); }
        }

        .app.launching {
            animation: launch 0.3s ease-out;
        }

        @keyframes ripple {
            0% { 
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
        
        @keyframes buttonRipple {
            to {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }
        
        @keyframes buttonBounce {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1.05); }
        }

.buy-menu-btn.playlist-active .star-path {
    fill: white;
    stroke: white;
    stroke-width: 2;
    filter: drop-shadow(0 1px 3px rgba(0, 0, 0, 0.4));
}

.menu-item.audio-selected {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.6);
}

.menu-item.audio-selected .icon {
    filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.6));
}

.audio-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: inherit;
}

.audio-modal-overlay.active {
    opacity: 1;
}

.audio-modal {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(25px);
    border-radius: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 30px;
    max-width: 350px;
    width: 90%;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    transform: scale(0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.audio-modal-overlay.active .audio-modal {
    transform: scale(1);
}

.audio-modal-title {
    color: white;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.audio-devices-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 20px;
}

.audio-device-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    outline: none;
}

.audio-device-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    border-color: rgba(255, 255, 255, 0.4);
    transform: scale(1.02);
}

.audio-device-btn:active {
    transform: scale(0.98);
}

.device-icon {
    font-size: 16px;
}

.device-name {
    flex: 1;
    text-align: left;
}

.audio-modal-close {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    color: white;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    outline: none;
}

.audio-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .hint-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 200;
        }

        .hint-overlay.show {
            opacity: 1;
        }

        .hint-icon {
            position: absolute;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .hint-prev {
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
        }

        .hint-next {
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
        }

        .hint-play {
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .hint-menu {
            left: 50%;
            top: -25px;
            transform: translateX(-50%);
        }

        @media (max-width: 768px) {
    body {
        justify-content: center;
        align-items: flex-start; /* Changed from center */
        padding: 0;
        background: rgba(0, 0, 0, 0.3);
        padding-top: env(safe-area-inset-top, 44px); /* Account for menu bar */
    }

    .phone-container {
        width: 100vw;
        height: calc(100vh - env(safe-area-inset-top, 44px)); /* Subtract menu bar height */
        border-radius: 0;
        padding: 20px 20px 120px 20px; /* Reduced top padding */
        animation: none;
        position: relative;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(25px);
        border: none;
        margin-top: 0; /* Ensure it starts right below menu bar */
    }

            .phone-container.settings-stretched,
            .phone-container.buy-stretched,
            .phone-container.search-mode {
                height: 100vh;
                border-radius: 0;
                padding: 60px 30px 120px 30px;
            }

            .status-bar {
    height: 120px;
    padding-top: 70px;
    margin-bottom: 20px;
}

            .curved-text {
                width: 100%;
                max-width: 350px;
                margin-top: 79px !important;
            }

            .curved-text svg {
                width: 100%;
            }

             .curved-text text {
        font-size: 18px;
        font-weight: 600;
    }

        
.media-player {
    position: relative;
    top: 10px;
    width: 220px;
    height: 220px;
    padding: 25px;
    margin: 0 auto 30px auto;
    left: auto;
    transform: none;
    border-radius: 20px; /* Changed from 50% to make it square */
}

    .control-row {
        flex-direction: row;
        gap: 8px;
        justify-content: center;
    }


        .apps-grid {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        height: auto;
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 0;
    }
    
    /* Hide apps when menus are active */
    .phone-container.settings-stretched .apps-grid,
    .phone-container.buy-stretched .apps-grid {
        display: none !important;
    }


            .app {
                position: relative;
                bottom: auto;
                left: auto;
                right: auto;
                transform: none;
                width: 100px;
                height: 100px;
                margin: 0 auto;
            }

            .Pals,
            .Notes,
            .Carts {
                position: relative;
                bottom: auto;
                left: auto;
                right: auto;
                transform: none;
            }

            .app-name {
                display: none;
            }

            .app-icon {
                width: 80px;
                height: 80px;
            }

.search-btn {
    display: none !important;
}
            .search-container {
                top: 80px;
                width: calc(100% - 40px);
                max-width: none;
                padding: 0 20px;
            }

            .search-bar {
                padding: 18px 20px;
                font-size: 16px;
            }

.phone-container.notes-mode {
        width: 100vw;
        height: calc(100vh - env(safe-area-inset-top, 44px));
        border-radius: 0;
        padding: 20px;
        top: 0;
        right: 0;
        margin-top: env(safe-area-inset-top, 44px);
    }
    
    .notes-container {
        top: 5px;
        left: 5px;
        right: 5px;
        bottom: 5px;
        border-radius: 15px;
    }

.settings-menu-dropdown {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%) scale(0);
    width: 280px;
    height: 300px;
    border-radius: 25px;
    padding: 30px 0px;
    gap: 25px;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr 1fr;
    place-items: center;
    align-content: center;
    justify-content: center;
}
    
    .settings-menu-dropdown.active {
        transform: translateX(-50%) scale(1);
    }
    
    /* Make control-rows invisible to grid - pass through their children */
    .settings-menu-dropdown .control-row {
        display: contents !important;
    }
    
    /* Hide the separator completely */
    .settings-menu-dropdown .menu-separator {
        display: none !important;
    }

.settings-menu-dropdown .menu-item {
    width: 80px;
    height: 80px;
    padding: 10px;
    border-radius: 50%;
    margin: 0;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 4px;
    text-align: center;
}

.settings-menu-dropdown .menu-item .icon {
    font-size: 22px;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 2px;
}

    .settings-menu-dropdown .menu-item .menu-label {
    opacity: 1;
    font-size: 10px;
    font-weight: 600;
    text-align: center;
    line-height: 1;
    transition: opacity 0.3s ease;
    width: 100%;
}
    
    /* Show labels after timer on mobile */
    .settings-menu-dropdown.show-mobile-labels .menu-item .menu-label {
        opacity: 1;
    }


    .buy-menu-dropdown {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: auto;
        max-height: 60vh;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        padding: 30px 20px;
    }

    .buy-menu-dropdown.active {
        transform: translateY(0);
    }

            .menu-item {
                width: 100%;
                max-width: none;
                height: 60px;
                border-radius: 15px;
                padding: 15px 20px;
                margin-bottom: 15px;
                justify-content: flex-start;
                gap: 15px;
            }

            .menu-item .icon {
                font-size: 24px;
                width: 30px;
            }

            .menu-item .label {
                display: block;
                font-size: 16px;
                flex: 1;
                text-align: left;
            }

            .menu-item .menu-label {
                opacity: 1;
                font-size: 16px;
            }

            .menu-item .price {
                font-size: 14px;
                padding: 8px 12px;
            }

            .control-row {
                flex-direction: column;
                gap: 15px;
            }

            .external-media-controls {
                display: none;
            }

            .volume-slider {
                display: none;
            }


 /* Hide the original curved SVG progress bar on mobile */
    .progress-slider svg {
        display: none;
    }
    
    /* Create a new flat progress bar */
   .progress-slider {
    position: absolute;
    bottom: 15px;
    left: 25px;
    right: 25px;
    width: auto;
    height: 6px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    cursor: pointer;
    z-index: 100;
    transform: none; /* Add this line to fix the positioning */
}
    
    /* Progress fill bar */
    .progress-slider::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 5%; /* This should match the current progress */
        background: rgba(255, 255, 255, 0.6);
        border-radius: 3px;
        transition: width 0.3s ease;
        pointer-events: none;
    }

            .floating-song-bubble {
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 14px;
                padding: 15px 25px;
            }

            .search-music-btn {
                top: 30px;
                width: 60px;
                height: 60px;
            }
            
            /* Mobile Swipe Indicator */
            .mobile-swipe-indicator {
                position: fixed;
                bottom: 5px;
                left: 50%;
                transform: translateX(-50%);
                width: 60px;
                height: 4px;
                background: rgba(255, 255, 255, 0.4);
                border-radius: 2px;
                animation: pulseSwipe 2s ease-in-out infinite;
            }
            
            @keyframes pulseSwipe {
                0%, 100% { opacity: 0.3; }
                50% { opacity: 0.8; }
            }
        }

    </style>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <div class="volume-slider">
                <svg viewBox="0 0 50 200">
                    <path class="volume-track" d="M 25 184 Q -10 100 25 16" stroke-dasharray="200" stroke-dashoffset="0"></path>
                    <path class="volume-fill" d="M 25 184 Q -10 100 25 16" stroke-dasharray="200" stroke-dashoffset="40" id="volumeFill"></path>
                </svg>
            </div>

            <div class="status-bar">
                <div class="curved-text" onclick="handleSongTitleClick()" style="cursor: pointer;" title="Click to change message">
                    <svg viewBox="0 0 450 80">
                        <defs>
                            <path id="curve1" d="M 50 25 Q 225 5 400 25" />
                            <path id="curve2" d="M 50 50 Q 225 30 400 50" />
                        </defs>
                        <text>
                            <textPath href="#curve1" startOffset="50%" id="greeting-text-line1">
                                Good vibes only! ‚ú®
                            </textPath>
                        </text>
                        <text>
                            <textPath href="#curve2" startOffset="50%" id="greeting-text-line2">
                                
                            </textPath>
                        </text>
                    </svg>
                </div>
            </div>

            <div class="apps-grid">
<div class="app Notes" onclick="launchApp('Notes')">
    <div class="app-icon"></div>
    <div class="app-name">Notes</div>
</div>
<div class="app Pals" onclick="launchApp('Pals')">
    <div class="app-icon"></div>
    <div class="app-name">Pals</div>
</div>
<div class="app Carts" onclick="launchApp('Carts')">
    <div class="app-icon"></div>
    <div class="app-name">Carts</div>
</div>
            </div>

            <!-- External media controls positioned on the sides -->
            <div class="external-media-controls">
                <button class="control-btn-external prev" onclick="previousTrack()">‚èÆ</button>
                <button class="control-btn-external next" onclick="nextTrack()">‚è≠</button>
            </div>

            <div class="media-player" onclick="handleMediaPlayerClick(event)">
                <button class="buy-menu-btn" onclick="toggleSettingsMenu(event)" style="display: none;">
<svg viewBox="0 0 24 24">
<path class="star-path" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
</svg>
</button>

                <!-- Hint overlays -->
                <div class="hint-overlay" id="hintOverlay">
                    <div class="hint-icon hint-prev">‚èÆ</div>
                    <div class="hint-icon hint-next">‚è≠</div>
                    <div class="hint-icon hint-play">‚èØ</div>
                    <div class="hint-icon hint-menu">‚öôÔ∏è</div>
                </div>


                <!-- Curved track title at the top of the inner circle -->
                <div class="track-title-curved">
                    <svg viewBox="0 0 250 60">
                        <defs>
                            <path id="track-curve" d="M 30 40 Q 125 15 220 40" />
                        </defs>
                        <text>
                            <textPath href="#track-curve" startOffset="50%" id="track-title-text">
                                Chill Vibes
                            </textPath>
                        </text>
                    </svg>
                </div>

                <div class="progress-slider" onclick="handleProgressClick(event)" onmousedown="startProgressScrubbing(event)" ontouchstart="startProgressScrubbing(event)">
                    <svg viewBox="0 0 200 100">
                        <path class="progress-track" d="M 20 20 Q 100 80 180 20" stroke-dasharray="200" stroke-dashoffset="0"></path>
                        <path class="progress-fill" d="M 20 20 Q 100 80 180 20" stroke-dasharray="200" stroke-dashoffset="190" id="progressFill"></path>
                    </svg>
                </div>
            </div>

            <div class="buy-menu-dropdown" id="buyMenuDropdown">
                <button class="menu-item" onclick="addToFavorites()">
                    <span class="icon">‚òÜ</span>
                    <span class="label">Library</span>
                    <span class="price">‚≠ê 100</span>
                </button>
                <button class="menu-item" onclick="buySong()">
                    <span class="icon">‚¨á</span>
                    <span class="label">Device</span>
                    <span class="price">$ 0.5</span>
                </button>
            </div>

            <div class="settings-menu-dropdown" id="settingsMenuDropdown">
                <div class="control-row">
<button class="menu-item" onclick="togglePlaylist()" id="playlistBtn">
<span class="icon">‚ûï</span>
<span class="menu-label">Library</span>
</button>
<button class="menu-item" onclick="changeAudioOutput()" id="audioOutputBtn">
<span class="icon">üé∂</span>
<span class="menu-label">Source</span>
</button>
</div>
<div class="menu-separator"></div>
<div class="control-row">
<button class="menu-item" onclick="shareMusic()" id="shareBtn">
<span class="icon">üöÄ</span>
<span class="menu-label">Copy</span>
</button>
<button class="menu-item" onclick="toggleLyrics()" id="lyricsBtn">
<span class="icon">üé§</span>
<span class="menu-label">Lyrics</span>
</button>
</div>
<div class="control-row">
<button class="menu-item" onclick="toggleRandomize()" id="randomizeBtn">
<span class="icon">üîÄ</span>
<span class="menu-label">Shuffle</span>
</button>
<button class="menu-item" onclick="toggleLoopSong()" id="loopSongBtn">
<span class="icon">üîÇ</span>
<span class="menu-label">Repeat</span>
</button>
</div>
            </div>

            <!-- Search Button -->
            <button class="search-btn" onclick="toggleSearchMode()" id="searchBtn">
                <svg viewBox="0 0 24 24">
                    <circle class="search-path" cx="11" cy="11" r="8"/>
                    <path class="search-path" d="m21 21-4.35-4.35"/>
                </svg>
            </button>

            <!-- Search Container -->
            <!-- Notes Container (moved outside search container) -->
<div class="notes-container" id="notesContainer">
    <div id="notesContent" style="width: 100%; height: 100%; overflow: hidden;">
        <!-- Notes content will be loaded here -->
    </div>
</div>

<div class="search-container" id="searchContainer">
    <input type="text" class="search-bar" placeholder="Find what you're been searching for" id="searchInput" oninput="handleSearch()" />
    <div class="search-results" id="searchResults"></div>
</div>

            <!-- Search Music Button (Back) -->
<button class="search-music-btn" onclick="exitSearchMode()" id="searchMusicBtn" title="Back to Music">
</button>
<!-- Floating Song Bubble -->
<div class="floating-song-bubble" onclick="exitSearchMode()" id="floatingSongBubble">
    üéµ Chill Vibes üéµ
</div>
        </div>
    </div>

    <script>

// Add these to your global variables section:
let notesPenStroke = 2;
let notesHighlighterStroke = 8;
// Add these to your global variables:
let notesLinesMode = 'none'; // 'none', 'lines', 'grid'
let notesSelectedStrokes = [];
let notesLassoPath = [];
let notesIsDragging = false;
let notesStrokes = []; // Store all drawing strokes for lasso selection
let notesCurrentStroke = null;
let notesSettings = {
    penStroke: 2,
    highlighterStroke: 8,
    currentColor: '#000000',
    currentTool: 'pen',
    eraserMode: 'brush',
    lastTab: 'drawn'
};

        // This single function now handles all initial setup
async function initializeApp() {
    // 1. Immediately set up everything that doesn't need to wait
    updateTrackInfo(); // This sets the album art
    updateButtonStates();
    updateProgressDisplay(5);
    updateVolumeDisplay();
    startProgressAnimation();

    // 2. Fetch the quotes from your text file
    try {
        const response = await fetch('quotes.txt');
        if (!response.ok) throw new Error('Network response was not ok');
        const text = await response.text();
        messages = text.split('\n').filter(line => line.trim() !== '');
    } catch (error) {
        console.error('Error loading messages, using fallback:', error);
        messages = ["Good vibes only! ‚ú®"]; // Fallback if fetch fails
    }

    // 3. Finally, set the message text, which was the only part that needed to wait
    setRandomMessage();
}

// Add this new function right after 'let messages = [];'
        async function loadQuotesAndSetMessage() {
            try {
                const response = await fetch('quotes.txt');
                if (!response.ok) throw new Error('Network response was not ok');
                const text = await response.text();
                messages = text.split('\n').filter(line => line.trim() !== '');
            } catch (error) {
                console.error('Error loading messages, using fallback:', error);
                messages = ["Good vibes only! ‚ú®"];
            }
            // Now that the quotes are loaded, set the message.
            setRandomMessage();
        }

        function setRandomMessage() {
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            const line1 = document.getElementById('greeting-text-line1');
            const line2 = document.getElementById('greeting-text-line2');
            
            if (randomMessage.length > 40) {
                const words = randomMessage.split(' ');
                const midPoint = Math.ceil(words.length / 2);
                const firstLine = words.slice(0, midPoint).join(' ');
                const secondLine = words.slice(midPoint).join(' ');
                
                line1.textContent = firstLine;
                line2.textContent = secondLine;
            } else {
                line1.textContent = randomMessage;
                line2.textContent = '';
            }
        }

        function changeGreetingText() {
            setRandomMessage();
            
            const phoneContainer = document.querySelector('.phone-container');
            phoneContainer.classList.add('white-effect');
            setTimeout(() => {
                phoneContainer.classList.remove('white-effect');
            }, 300);
        }

        let isPlaying = true;
        let userCoins = 150;
        let addedToPlaylist = false;
        let audioOutputSelected = false;
let isSearchMode = false;

        const tracks = [
             { title: "Chill Vibes", price: 0.5, duration: 180, albumArt: "music1.png" },
 { title: "Midnight Jazz", price: 0.5, duration: 225, albumArt: "music2.png" },
 { title: "Ocean Waves", price: 0.5, duration: 300, albumArt: "music3.png" },
 { title: "City Lights", price: 0.5, duration: 195, albumArt: "music4.png" },
 { title: "Forest Walk", price: 0.5, duration: 240, albumArt: "music5.png" },
 { title: "Neon Dreams", price: 0.5, duration: 210, albumArt: "music6.png" },
 { title: "Sunset Glow", price: 0.5, duration: 265, albumArt: "music7.png" },
 { title: "Cosmic Flow", price: 0.5, duration: 185, albumArt: "music8.png" },
 { title: "Urban Pulse", price: 0.5, duration: 220, albumArt: "music9.png" },
 { title: "Mountain Air", price: 0.5, duration: 275, albumArt: "music10.png" },
 { title: "Digital Rain", price: 0.5, duration: 190, albumArt: "music11.png" },
 { title: "Golden Hour", price: 0.5, duration: 250, albumArt: "music12.png" },
 { title: "Electric Soul", price: 0.5, duration: 205, albumArt: "music13.png" },
 { title: "Starlight", price: 0.5, duration: 230, albumArt: "music14.png" },
 { title: "Deep Space", price: 0.5, duration: 280, albumArt: "music15.png" },
 { title: "Morning Dew", price: 0.5, duration: 200, albumArt: "music16.png" },
 { title: "Neon Nights", price: 0.5, duration: 215, albumArt: "music17.png" },
 { title: "Crystal Clear", price: 0.5, duration: 260, albumArt: "music18.png" },
 { title: "Infinite Sky", price: 0.5, duration: 245, albumArt: "music19.png" }
        ];
        let currentTrack = 0;
        let favorites = [];
        let purchased = [];
        let isBuyMenuOpen = false;
        let isSettingsMenuOpen = false;
        let loopSong = false;
        let randomize = false;
        let showLyrics = false;
        let volume = 80;
        let isDraggingVolume = false;
        let isDraggingProgress = false;
        let progressInterval;
        let currentProgress = 5;
        let quoteRestoreTimer = null;
        let showingSongTitle = false;
        
        // Mobile swipe handling
        let startY = 0;
        let currentY = 0;
        let isDragging = false;
        let swipeThreshold = 100;
        let isMobile = window.innerWidth <= 768;

        // **NEW: Back button support and search context - Listen for messages from parent window**
        window.addEventListener('message', function(event) {
            try {
                console.log('Iframe received message:', event.data);
                
                if (event.data && event.data.action === 'goBack') {
                    console.log('goBack message received - handling navigation');
                    handleBackNavigation();
                }
                else if (event.data && event.data.action === 'setSearchWithContext') {
                    console.log('Search with context received:', event.data);
                    setSearchWithContext(event.data.searchTerm, event.data.context);
                }
            } catch (error) {
                console.log('Message handling error in iframe:', error);
            }
        });


        function setSearchWithContext(searchTerm, context) {
            // Auto-open search mode
            if (!isSearchMode) {
                toggleSearchMode();
            }
            
            // Wait for search mode to open, then set the search term and context
            setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.value = searchTerm;
                    
                    // Add context chip if provided
                    if (context) {
                        addSearchContext(context);
                    }
                    
                    // Trigger search
                    handleSearch();
                }
            }, 600);
        }
        
        function addSearchContext(contextText) {
            const searchContainer = document.getElementById('searchContainer');
            if (!searchContainer) return;
            
            // Check if context already exists
            const existingContexts = searchContainer.querySelectorAll('.search-context-chip .context-text');
            for (let existingContext of existingContexts) {
                if (existingContext.textContent === contextText) {
                    console.log(`Context "${contextText}" already exists, skipping duplicate`);
                    return; // Don't add duplicate
                }
            }
            
            // Create context chip
            const contextChip = document.createElement('div');
            contextChip.className = 'search-context-chip';
            contextChip.innerHTML = `
                <span class="context-text">${contextText}</span>
                <button class="context-remove" onclick="removeSearchContext(this)" title="Remove context">√ó</button>
            `;
            
            // Insert before search input
            const searchBar = searchContainer.querySelector('.search-bar');
            searchContainer.insertBefore(contextChip, searchBar);
            
            console.log(`Added search context: ${contextText}`);
        }
        
        function removeSearchContext(button) {
            const chip = button.closest('.search-context-chip');
            if (chip) {
                chip.remove();
                console.log('Removed search context');
            }
        }

        function handleBackNavigation() {
            // Check if any notes dropdown is open
    const openDropdowns = ['fontDropdown', 'sizeDropdown', 'colorsDropdown', 'eraserDropdown', 'penDropdown', 'highlighterDropdown'].some(id => {
        const dropdown = document.getElementById(id);
        return dropdown && dropdown.style.display === 'block';
    });
    
    if (openDropdowns) {
        // Close all dropdowns instead of dismissing blob
        ['fontDropdown', 'sizeDropdown', 'colorsDropdown', 'eraserDropdown', 'penDropdown', 'highlighterDropdown'].forEach(id => {
            const dropdown = document.getElementById(id);
            if (dropdown) dropdown.style.display = 'none';
        });
        return;
    }
    // On mobile, always dismiss - no nested navigation
    if (isMobile) {
        console.log('Mobile detected - dismissing overlay');
        dismissBlob();
        return;
    }
    
    // Handle back navigation based on current state (desktop only)
    let navigationHandled = false;
    
    // Priority 1: If in notes mode, dismiss entire blob (notes + blob)
    if (isNotesMode) {
        console.log('In notes mode - dismissing entire overlay');
        dismissBlob();
        navigationHandled = false; // Let parent handle dismissal
    }
    // Priority 2: If in search mode, exit search mode
    else if (isSearchMode) {
        console.log('Exiting search mode as back action');
        exitSearchMode();
        navigationHandled = true;
    }
    // Priority 3: If buy menu is open, close it
    else if (isBuyMenuOpen) {
        console.log('Closing buy menu as back action');
        toggleBuyMenu();
        navigationHandled = true;
    }
    // Priority 4: If settings menu is open, close it
    else if (isSettingsMenuOpen) {
        console.log('Closing settings menu as back action');
        toggleSettingsMenu();
        navigationHandled = true;
    }
    // Priority 5: If at main interface, dismiss the entire overlay
    else {
        console.log('At main interface - dismissing overlay');
        navigationHandled = false; // Let parent handle dismissal
    }
            
            // If we handled the navigation internally, tell parent not to dismiss
            if (navigationHandled) {
                // Don't send dismissOverlay - we handled it internally
                console.log('Navigation handled internally');
            } else {
                // Send dismiss message to parent to close the overlay
                console.log('Sending dismissOverlay message to parent');
                window.parent.postMessage({ action: 'dismissOverlay' }, '*');
            }
        }

        // **NEW: Handle clicks outside the phone container as back button**
        document.addEventListener('click', function(event) {
            const phoneContainer = document.querySelector('.phone-container');
            
            // Check if click is outside the phone container
            if (phoneContainer && !phoneContainer.contains(event.target)) {
                console.log('Click detected outside phone container - triggering back navigation');
                event.preventDefault();
                event.stopPropagation();
                handleBackNavigation();
            }
        });

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function setSongTitle() {
    const line1 = document.getElementById('greeting-text-line1');
    const line2 = document.getElementById('greeting-text-line2');
    const songTitle = `üéµ ${tracks[currentTrack].title} üéµ`;
    
    line1.textContent = songTitle;
    line2.textContent = '';
    showingSongTitle = true;
    
    if (quoteRestoreTimer) {
        clearTimeout(quoteRestoreTimer);
        quoteRestoreTimer = null;
    }
}

function restoreQuotes() {
    if (showingSongTitle) {
        setRandomMessage();
        showingSongTitle = false;
    }
}

        function updateTrackInfo() {
    const trackTitleElement = document.getElementById('track-title-text');
    const mediaPlayer = document.querySelector('.media-player');
    
    if (trackTitleElement) {
        trackTitleElement.textContent = tracks[currentTrack].title;
    }
    
    if (mediaPlayer) {
        const albumArt = tracks[currentTrack].albumArt;
        mediaPlayer.style.backgroundImage = `url('${albumArt}')`;
    }
    
    // Update song title at top if currently playing
    if (isPlaying) {
        setSongTitle();
    }
}

        function isSongPurchased(trackIndex) {
            return purchased.some(song => song.title === tracks[trackIndex].title);
        }

        function isSongFavorited(trackIndex) {
            return favorites.some(song => song.title === tracks[trackIndex].title);
        }

        function updateButtonState(buttonId, isActive) {
            const button = document.getElementById(buttonId);
            if (button) {
                if (isActive) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            }
        }

        function togglePlay() {
    const phoneContainer = document.querySelector('.phone-container');
    
    isPlaying = !isPlaying;
    
    // Don't show effects in notes mode
    if (!isNotesMode) {
        if (isPlaying) {
            setSongTitle();
            // Green tint when playing/resuming
            phoneContainer.classList.add('purchase-effect');
            setTimeout(() => {
                phoneContainer.classList.remove('purchase-effect');
            }, 800);
        } else {
            // Red tint when pausing
            phoneContainer.classList.add('remove-effect');
            setTimeout(() => {
                phoneContainer.classList.remove('remove-effect');
            }, 800);
            
            // Start 5-second timer to restore quotes
            if (quoteRestoreTimer) clearTimeout(quoteRestoreTimer);
            quoteRestoreTimer = setTimeout(restoreQuotes, 5000);
        }
    }
}

function handleMediaPlayerClick(event) {
    // Show hints on first click anywhere on album circle
    if (!hasClickedAlbum) {
        hasClickedAlbum = true;
        showHints();
    }
    
    const mediaPlayer = event.currentTarget;
    const rect = mediaPlayer.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const clickX = event.clientX;
    const clickY = event.clientY;
    
    // Calculate relative position from center
    const relativeY = clickY - centerY;
    const relativeX = clickX - centerX;
    const radius = rect.width / 2;
    
    // Check if click is in top quarter of the circle
    if (relativeY < -radius * 0.3) {
        // Clicked top area - open settings menu (the one with playlist controls)
        event.stopPropagation();
        console.log("Top area clicked - opening settings menu");
        toggleSettingsMenu();
        return;
    }
    
    const edgeThreshold = rect.width * 0.25;
    
    if (relativeX < -edgeThreshold) {
        // Clicked left edge - previous track
        previousTrack();
    } else if (relativeX > edgeThreshold) {
        // Clicked right edge - next track  
        nextTrack();
    } else {
        // Clicked center - toggle play
        togglePlay();
    }
}

        function createButtonRipple(button) {
            const ripple = document.createElement('div');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            
            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%);
                border-radius: 50%;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                animation: buttonRipple 0.6s ease-out;
                pointer-events: none;
                z-index: 10;
            `;
            
            button.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        }

        function previousTrack() {
            const btn = document.querySelector('.control-btn-external.prev');
            const phoneContainer = document.querySelector('.phone-container');
            
            phoneContainer.classList.add('black-effect');
            
            createButtonRipple(btn);
            btn.style.animation = 'buttonBounce 0.3s ease-out';
            
            currentTrack = (currentTrack - 1 + tracks.length) % tracks.length;
            updateTrackInfo();
            updateButtonStates();
            currentProgress = 5;
            updateProgressDisplay(5);
            
            setTimeout(() => {
                btn.style.animation = '';
                phoneContainer.classList.remove('black-effect');
            }, 400);
        }

        function nextTrack() {
            const btn = document.querySelector('.control-btn-external.next');
            const phoneContainer = document.querySelector('.phone-container');
            
            phoneContainer.classList.add('white-effect');
            
            createButtonRipple(btn);
            btn.style.animation = 'buttonBounce 0.3s ease-out';
            
            currentTrack = (currentTrack + 1) % tracks.length;
            updateTrackInfo();
            updateButtonStates();
            currentProgress = 5;
            updateProgressDisplay(5);
            
            setTimeout(() => {
                btn.style.animation = '';
                phoneContainer.classList.remove('white-effect');
            }, 400);
        }

        // Progress scrubbing functionality
        function handleProgressClick(event) {
            if (isDraggingProgress) return;
            
            event.stopPropagation();
            updateProgressFromEvent(event);
        }

        function startProgressScrubbing(event) {
            event.stopPropagation();
            isDraggingProgress = true;
            updateProgressFromEvent(event);
            
            document.addEventListener('mousemove', continueProgressScrubbing);
            document.addEventListener('mouseup', stopProgressScrubbing);
            document.addEventListener('touchmove', continueProgressScrubbing);
            document.addEventListener('touchend', stopProgressScrubbing);
        }

        function continueProgressScrubbing(event) {
            if (isDraggingProgress) {
                updateProgressFromEvent(event);
                event.preventDefault();
            }
        }

        function stopProgressScrubbing() {
            isDraggingProgress = false;
            document.removeEventListener('mousemove', continueProgressScrubbing);
            document.removeEventListener('mouseup', stopProgressScrubbing);
            document.removeEventListener('touchmove', continueProgressScrubbing);
            document.removeEventListener('touchend', stopProgressScrubbing);
        }

      let progressEffectTimer = null;

        function updateProgressFromEvent(event) {
            const progressSlider = document.querySelector('.progress-slider svg');
            if (!progressSlider) return;
            
            const rect = progressSlider.getBoundingClientRect();
            const clientX = event.clientX || (event.touches && event.touches[0].clientX);
            const clickX = clientX - rect.left;
            const width = rect.width;
            
            // Convert click position to progress percentage (accounting for the curved path)
            const percentage = Math.max(0, Math.min(100, (clickX / width) * 100));
            
            currentProgress = percentage;
            updateProgressDisplay(percentage);
            
            const phoneContainer = document.querySelector('.phone-container');
            phoneContainer.classList.add('black-effect');
            
            // Clear existing timer and set new one
            if (progressEffectTimer) clearTimeout(progressEffectTimer);
            progressEffectTimer = setTimeout(() => {
                phoneContainer.classList.remove('black-effect');
                progressEffectTimer = null;
            }, 1000);
            
            console.log(`Scrubbed to ${percentage.toFixed(1)}%`);
        }

        // Progress scrubbing functionality
        function handleProgressClick(event) {
            if (isDraggingProgress) return;
            
            event.stopPropagation();
            updateProgressFromEvent(event);
        }

        function startProgressScrubbing(event) {
            event.stopPropagation();
            isDraggingProgress = true;
            updateProgressFromEvent(event);
            
            document.addEventListener('mousemove', continueProgressScrubbing);
            document.addEventListener('mouseup', stopProgressScrubbing);
            document.addEventListener('touchmove', continueProgressScrubbing);
            document.addEventListener('touchend', stopProgressScrubbing);
        }

        function continueProgressScrubbing(event) {
            if (isDraggingProgress) {
                updateProgressFromEvent(event);
                event.preventDefault();
            }
        }

        function stopProgressScrubbing() {
            isDraggingProgress = false;
            document.removeEventListener('mousemove', continueProgressScrubbing);
            document.removeEventListener('mouseup', stopProgressScrubbing);
            document.removeEventListener('touchmove', continueProgressScrubbing);
            document.removeEventListener('touchend', stopProgressScrubbing);
        }


        function addToFavorites() {
            toggleBuyMenu();
            
            if (userCoins >= 100) {
                userCoins -= 100;
                const currentSong = tracks[currentTrack];
                favorites.push(currentSong);
                
                updateButtonStates();
                
                const phoneContainer = document.querySelector('.phone-container');
                phoneContainer.classList.add('gold-effect');
                
                setTimeout(() => {
                    phoneContainer.classList.remove('gold-effect');
                }, 800);
                
                console.log(`Added "${currentSong.title}" to favorites! Coins remaining: ${userCoins}`);
            } else {
                alert(`Not enough coins! You have ${userCoins} coins but need 100 to save to library.`);
            }
        }

        function buySong() {
            toggleBuyMenu();
            
            const currentSong = tracks[currentTrack];
            purchased.push(currentSong);
            
            updateButtonStates();
            
            const phoneContainer = document.querySelector('.phone-container');
            phoneContainer.classList.add('purchase-effect');
            
            setTimeout(() => {
                phoneContainer.classList.remove('purchase-effect');
            }, 2000);
            
            console.log(`Purchased "${currentSong.title}" for ${currentSong.price}! Song downloaded.`);
        }

        function toggleBuyMenu(event) {
            if (event) event.stopPropagation();
            
            const dropdown = document.getElementById('buyMenuDropdown');
            const button = document.querySelector('.buy-menu-btn');
            const phoneContainer = document.querySelector('.phone-container');
            
            phoneContainer.classList.add('blue-effect');
            setTimeout(() => {
                phoneContainer.classList.remove('blue-effect');
            }, 400);
            
            if (isSettingsMenuOpen) {
                transitionToMenu('buy');
                return;
            }
            
            isBuyMenuOpen = !isBuyMenuOpen;
            
            if (isBuyMenuOpen) {
                updateBuyMenuOptions();
                
                button.classList.add('collapsed');
                setTimeout(() => {
                    button.classList.remove('collapsed');
                    button.classList.add('expanded');
                    phoneContainer.classList.add('buy-stretched');
                    setTimeout(() => {
                        dropdown.classList.add('active');
                        button.classList.remove('expanded');
                    }, 200);
                }, 200);
            } else {
                dropdown.classList.remove('active');
                button.classList.add('collapsed');
                setTimeout(() => {
                    phoneContainer.classList.remove('buy-stretched');
                    button.classList.remove('collapsed');
                }, 200);
            }
        }

function toggleSettingsMenu(event) {
 if (event) event.stopPropagation();
const dropdown = document.getElementById('settingsMenuDropdown');
const phoneContainer = document.querySelector('.phone-container');
phoneContainer.classList.add('blue-effect');
setTimeout(() => {
phoneContainer.classList.remove('blue-effect');
 }, 400);
if (isBuyMenuOpen) {
// Close buy menu first
const buyDropdown = document.getElementById('buyMenuDropdown');
buyDropdown.classList.remove('active');
phoneContainer.classList.remove('buy-stretched');
isBuyMenuOpen = false;
 }
isSettingsMenuOpen = !isSettingsMenuOpen;

if (isSettingsMenuOpen) {
    phoneContainer.classList.add('settings-stretched');
    setTimeout(() => {
        dropdown.classList.add('active');
        // Set timer to show menu hints after 5 seconds on desktop, 4 seconds on mobile
        const isMobile = window.innerWidth <= 768;
        const delay = isMobile ? 4000 : 5000;
        
        menuTimer2 = setTimeout(() => {
            if (isMobile) {
                // On mobile, just add class to show labels
                dropdown.classList.add('show-mobile-labels');
            } else {
                // On desktop, use existing hover system
                showMenuHints();
            }
        }, delay);
    }, 200);
}
 
 else {
dropdown.classList.remove('active');
hideMenuHints(); // Hide menu hints when closing
setTimeout(() => {
phoneContainer.classList.remove('settings-stretched');
 }, 200);
 }
}

        function transitionToMenu(targetMenu) {
            const phoneContainer = document.querySelector('.phone-container');
            const buyDropdown = document.getElementById('buyMenuDropdown');
            const settingsDropdown = document.getElementById('settingsMenuDropdown');
            const buyButton = document.querySelector('.buy-menu-btn');
            const settingsButton = document.querySelector('.settings-menu-btn');
            
            if (targetMenu === 'buy' && isSettingsMenuOpen) {
                settingsDropdown.classList.remove('active');
                settingsButton.classList.add('collapsed');
                settingsButton.classList.remove('active-glow');
                
                setTimeout(() => {
                    phoneContainer.classList.remove('settings-stretched');
                    phoneContainer.classList.add('buy-stretched');
                    
                    isSettingsMenuOpen = false;
                    isBuyMenuOpen = true;
                    
                    updateBuyMenuOptions();
                    
                    settingsButton.classList.remove('collapsed');
                    buyButton.classList.add('expanded');
                    setTimeout(() => {
                        buyDropdown.classList.add('active');
                        buyButton.classList.remove('expanded');
                    }, 200);
                }, 200);
                
            } else if (targetMenu === 'settings' && isBuyMenuOpen) {
                buyDropdown.classList.remove('active');
                buyButton.classList.add('collapsed');
                
                setTimeout(() => {
                    phoneContainer.classList.remove('buy-stretched');
                    phoneContainer.classList.add('settings-stretched');
                    
                    isBuyMenuOpen = false;
                    isSettingsMenuOpen = true;
                    
                    settingsButton.classList.add('active-glow');
                    
                    buyButton.classList.remove('collapsed');
                    settingsButton.classList.add('expanded');
                    setTimeout(() => {
                        settingsDropdown.classList.add('active');
                        settingsButton.classList.remove('expanded');
                    }, 200);
                }, 200);
            }
        }

        function updateButtonStates() {
            const buyButton = document.querySelector('.buy-menu-btn');
            const currentSong = tracks[currentTrack];
            
            buyButton.classList.remove('favorited', 'purchased', 'purchased-and-favorited');
            
            const isPurchased = isSongPurchased(currentTrack);
            const isFavorited = isSongFavorited(currentTrack);
            
            if (isPurchased && isFavorited) {
                buyButton.classList.add('purchased-and-favorited');
            } else if (isPurchased) {
                buyButton.classList.add('purchased');
            } else if (isFavorited) {
                buyButton.classList.add('favorited');
            }
        }

        function updateBuyMenuOptions() {
            const buyDropdown = document.getElementById('buyMenuDropdown');
            const currentSong = tracks[currentTrack];
            
            let menuHTML = '';
            
            if (!isSongFavorited(currentTrack)) {
                menuHTML += `
                    <button class="menu-item" onclick="addToFavorites()">
                        <span class="icon">‚òÜ</span>
                        <span class="label">Library</span>
                        <span class="price">‚≠ê 100</span>
                    </button>
                `;
            }
            
            if (!isSongPurchased(currentTrack)) {
                menuHTML += `
                    <button class="menu-item" onclick="buySong()">
                        <span class="icon">‚¨á</span>
                        <span class="label">Device</span>
                        <span class="price">$ ${currentSong.price}</span>
                    </button>
                `;
            }
            
            if (menuHTML === '') {
                menuHTML = `
                    <div style="padding: 12px; color: rgba(255,255,255,0.7); text-align: center; font-size: 11px;">
                        Song already saved to library and device
                    </div>
                `;
            }
            
            buyDropdown.innerHTML = menuHTML;
        }

function togglePlaylist() {
    const phoneContainer = document.querySelector('.phone-container');
    
    addedToPlaylist = !addedToPlaylist;
    const playlistBtn = document.getElementById('playlistBtn');
    const icon = playlistBtn.querySelector('.icon');
    const label = playlistBtn.querySelector('span:last-child');
    const starButton = document.querySelector('.buy-menu-btn');
    
    if (addedToPlaylist) {
        icon.textContent = '‚ûñ';
        label.textContent = 'Forget';
        
        starButton.classList.add('playlist-active');
        
        // Green tint when adding to playlist
        phoneContainer.classList.add('purchase-effect');
        setTimeout(() => {
            phoneContainer.classList.remove('purchase-effect');
        }, 800);
    } else {
        icon.textContent = '‚ûï';
        label.textContent = 'Remember';
        
        starButton.classList.remove('playlist-active');
        
        // Red tint when removing from playlist
        phoneContainer.classList.add('remove-effect');
        setTimeout(() => {
            phoneContainer.classList.remove('remove-effect');
        }, 800);
    }
    
    console.log(`${addedToPlaylist ? 'Added to' : 'Removed from'} playlist: "${tracks[currentTrack].title}"`);
}

async function changeAudioOutput() {
    console.log('Audio output button clicked');
    
    // Pause music during device selection
    if (isPlaying) {
        isPlaying = false;
    }
    
    let micStream = null;
    
    try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
            console.log('MediaDevices API not supported');
            alert('Audio output selection not supported in this browser');
            return;
        }
        
        console.log('Getting temporary microphone access for device detection...');
        
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        // Immediately stop the microphone stream
        if (micStream) {
            micStream.getTracks().forEach(track => {
                track.stop();
                console.log('Microphone track stopped');
            });
            micStream = null;
        }
        
        const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
        
        if (audioOutputs.length <= 1) {
            console.log('Only one or no audio outputs available');
            alert('No additional audio outputs found');
            return;
        }
        
        showAudioOutputModal(audioOutputs);
        
    } catch (error) {
        console.error('Audio output selection failed:', error);
        alert(`Error: ${error.message}`);
        
        const phoneContainer = document.querySelector('.phone-container');
        phoneContainer.classList.add('blue-effect');
        setTimeout(() => {
            phoneContainer.classList.remove('blue-effect');
        }, 400);
    } finally {
        // Clean up microphone stream if it still exists
        if (micStream) {
            micStream.getTracks().forEach(track => track.stop());
        }
    }
}

function getDeviceIcon(deviceLabel) {
    const label = deviceLabel.toLowerCase();
    
    if (label.includes('headphone') || label.includes('airpods') || label.includes('beats') || label.includes('bose') || label.includes('sony') || label.includes('headset')) {
        return 'üéß';
    } else if (label.includes('macbook') || label.includes('laptop') || label.includes('built-in') || label.includes('internal') || label.includes('computer')) {
        return 'üíª';
    } else if (label.includes('tv') || label.includes('display') || label.includes('monitor') || label.includes('lg') || label.includes('samsung') || label.includes('dell')) {
        return 'üì∫';
    } else if (label.includes('phone') || label.includes('mobile') || label.includes('iphone') || label.includes('android')) {
        return 'üì±';
    } else if (label.includes('speaker') || label.includes('bluetooth') || label.includes('wireless')) {
        return 'üîä';
    } else {
        return 'üé∂'; // Default audio icon
    }
}

function showAudioOutputModal(audioOutputs) {
    // Apply highlighting to audio button if it was previously selected
    const audioBtn = document.getElementById('audioOutputBtn');
    if (audioOutputSelected && audioBtn) {
        audioBtn.classList.add('audio-selected');
    }
    const modalHTML = `
        <div class="audio-modal-overlay" onclick="closeAudioModal()">
            <div class="audio-modal" onclick="event.stopPropagation()">
                <div class="audio-modal-title">Choose Audio Output</div>
                <div class="audio-devices-list">
                    ${audioOutputs.map((device, index) => `
                        <button class="audio-device-btn" onclick="selectAudioDevice('${device.deviceId}', '${device.label || `Speaker ${index + 1}`}')">
                            <span class="device-icon">${getDeviceIcon(device.label || '')}</span>
                            <span class="device-name">${device.label || `Speaker ${index + 1}`}</span>
                        </button>
                    `).join('')}
                </div>
                <button class="audio-modal-close" onclick="closeAudioModal()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => {
        document.querySelector('.audio-modal-overlay').classList.add('active');
    }, 10);
}

async function selectAudioDevice(deviceId, deviceName) {
    try {
        const audioElements = document.querySelectorAll('audio, video');
        for (const element of audioElements) {
            if (element.setSinkId) {
                await element.setSinkId(deviceId);
            }
        }
        
        console.log(`Audio output changed to: ${deviceName}`);
        
        // Mark audio output as selected (assuming it's not default if user chose it)
        audioOutputSelected = true;
        updateAudioButtonState();
        
        const phoneContainer = document.querySelector('.phone-container');
        phoneContainer.classList.add('purchase-effect');
        setTimeout(() => {
            phoneContainer.classList.remove('purchase-effect');
        }, 800);
        
        closeAudioModal();
        
        // Resume music after selecting new audio output
        isPlaying = true;
        
    } catch (error) {
        console.log('Failed to set audio output:', error);
        closeAudioModal();
    }
}
function updateAudioButtonState() {
    // We need to find the audio output button in the settings menu
    // This will be applied when the menu is opened
}
function closeAudioModal() {
    const modal = document.querySelector('.audio-modal-overlay');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.remove();
        }, 300);
    }
}

        function toggleLoopSong() {
            loopSong = !loopSong;
            updateButtonState('loopSongBtn', loopSong);
            
            const phoneContainer = document.querySelector('.phone-container');
            phoneContainer.classList.add(loopSong ? 'purchase-effect' : 'remove-effect');
            
            setTimeout(() => {
                phoneContainer.classList.remove(loopSong ? 'purchase-effect' : 'remove-effect');
            }, 800);
            
            console.log(`Song loop ${loopSong ? 'enabled' : 'disabled'}`);
        }

        function toggleRandomize() {
            randomize = !randomize;
            updateButtonState('randomizeBtn', randomize);
            
            const phoneContainer = document.querySelector('.phone-container');
            phoneContainer.classList.add(randomize ? 'purchase-effect' : 'remove-effect');
            
            setTimeout(() => {
                phoneContainer.classList.remove(randomize ? 'purchase-effect' : 'remove-effect');
            }, 800);
            
            console.log(`Randomize ${randomize ? 'enabled' : 'disabled'}`);
        }

        function toggleLyrics() {
            showLyrics = !showLyrics;
            updateButtonState('lyricsBtn', showLyrics);
            
            const phoneContainer = document.querySelector('.phone-container');
            phoneContainer.classList.add('purple-effect');
            
            setTimeout(() => {
                phoneContainer.classList.remove('purple-effect');
            }, 800);
            
            console.log(`Lyrics ${showLyrics ? 'shown' : 'hidden'}`);
        }

        function shareMusic() {
            const currentSong = tracks[currentTrack];
            const musicLink = `https://fsmusic.com/track/${currentSong.title.toLowerCase().replace(/\s+/g, '-')}`;
            
            const phoneContainer = document.querySelector('.phone-container');
            const shareBtn = document.getElementById('shareBtn');
            const icon = shareBtn.querySelector('.icon');
            const spans = shareBtn.querySelectorAll('span');
            const label = spans[spans.length - 1]; // Get the last span (the label)
            
            // Store original content
            const originalIcon = icon.textContent;
            const originalLabel = label.textContent;
            
            phoneContainer.classList.add('purchase-effect');
            
            // Change button to "Copied"
            icon.textContent = '‚úçÔ∏è';
            label.textContent = 'Copied';
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(musicLink).then(() => {
                    console.log(`Successfully copied music link to clipboard: ${musicLink}`);
                }).catch(err => {
                    console.log(`Clipboard not available, but showing visual feedback anyway. Link: ${musicLink}`);
                });
            } else {
                console.log(`Clipboard API not available. Music link: ${musicLink}`);
            }
            
            // Wait 1.5 seconds, then restore button and close menu
            setTimeout(() => {
                phoneContainer.classList.remove('purchase-effect');
                icon.textContent = originalIcon;
                label.textContent = originalLabel;
                toggleSettingsMenu();
            }, 1500);
        }

        let volumeEffectTimer = null;

        function handleVolumeScroll(event) {
            event.preventDefault();
            
            const scrollSensitivity = 0.2;
            const delta = event.deltaY * scrollSensitivity;
            const newVolume = Math.max(0, Math.min(100, volume + delta));
            
            if (newVolume !== volume) {
                volume = Math.round(newVolume);
                updateVolumeDisplay();
                console.log(`Volume: ${volume}% (scroll delta: ${event.deltaY.toFixed(1)})`);
                
                const phoneContainer = document.querySelector('.phone-container');
                phoneContainer.classList.add('black-effect');
                
                // Clear existing timer and set new one
                if (volumeEffectTimer) clearTimeout(volumeEffectTimer);
                volumeEffectTimer = setTimeout(() => {
                    phoneContainer.classList.remove('black-effect');
                    volumeEffectTimer = null;
                }, 1000);
            }
        }

        function updateVolumeDisplay() {
            const volumeFill = document.getElementById('volumeFill');
            if (!volumeFill) return;
            
            const totalLength = 200;
            const offset = totalLength * (1 - volume / 100);
            volumeFill.style.strokeDashoffset = offset;
        }

        function handleVolumeInteraction(event) {
            const volumeSlider = document.querySelector('.volume-slider svg');
            if (!volumeSlider) return;
            
            const rect = volumeSlider.getBoundingClientRect();
            
            const clientY = event.clientY || (event.touches && event.touches[0].clientY);
            const clickY = clientY - rect.top;
            const height = rect.height;
            
            const percentage = Math.max(0, Math.min(100, 100 - (clickY / height) * 100));
            
            volume = Math.round(percentage);
            updateVolumeDisplay();
            console.log(`Volume: ${volume}%`);
            
            const phoneContainer = document.querySelector('.phone-container');
            if (phoneContainer) {
                phoneContainer.classList.add('black-effect');
                
                // Clear existing timer and set new one
                if (volumeEffectTimer) clearTimeout(volumeEffectTimer);
                volumeEffectTimer = setTimeout(() => {
                    phoneContainer.classList.remove('black-effect');
                    volumeEffectTimer = null;
                }, 1000);
            }
        }

        function startVolumeHanding(event) {
            isDraggingVolume = true;
            handleVolumeInteraction(event);
            event.preventDefault();
        }

        function continueVolumeHanding(event) {
            if (isDraggingVolume) {
                handleVolumeInteraction(event);
                event.preventDefault();
            }
        }

        function stopVolumeHanding() {
            isDraggingVolume = false;
        }

        function launchApp(appName) {
    const app = document.querySelector(`.${appName}`);
    app.classList.add('launching');
    
    const ripple = document.createElement('div');
    ripple.style.cssText = `
        position: absolute;
        width: 150px;
        height: 150px;
        background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.4) 30%, rgba(255,255,255,0.1) 60%, transparent 100%);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        animation: ripple 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        pointer-events: none;
        z-index: 20;
        border: none;
        outline: none;
        box-shadow: none;
    `;
    
    app.appendChild(ripple);
    
    setTimeout(() => {
        app.classList.remove('launching');
        ripple.remove();
        console.log(`Launching ${appName}...`);
        
        // Handle Notes app specifically
        if (appName === 'Notes') {
    toggleNotesMode();
}
    }, 700);
}

        function startProgressAnimation() {
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(() => {
                if (isPlaying && !isDraggingProgress) {
                    if (currentProgress < 100) {
                        currentProgress += 0.5;
                        updateProgressDisplay(currentProgress);
                    } else {
                        currentProgress = 5;
                        nextTrack();
                    }
                }
            }, 200);
        }

        function updateProgressDisplay(progress) {
            const progressFill = document.getElementById('progressFill');
            if (!progressFill) return;
            
            const totalLength = 200;
            const offset = totalLength * (1 - progress / 100);
            progressFill.style.strokeDashoffset = offset;
        }

        window.addEventListener('load', () => {
            loadQuotesAndSetMessage(); // The new function goes here.
            updateTrackInfo();
            updateButtonStates();
            updateProgressDisplay(5);
            updateVolumeDisplay();
            startProgressAnimation();
            
            // Add mobile swipe functionality
            if (isMobile) {
                setupMobileSwipe();
                addMobileSwipeIndicator();
            }
            
            document.addEventListener('click', (e) => {
    const buyMenu = document.getElementById('buyMenuDropdown');
    const buyButton = document.querySelector('.buy-menu-btn');
    const settingsMenu = document.getElementById('settingsMenuDropdown');
    const settingsButton = document.querySelector('.settings-menu-btn');
    const searchButton = document.querySelector('.search-btn');
    const searchContainer = document.getElementById('searchContainer');
    const searchBackBtn = document.getElementById('searchMusicBtn');
    
    if (isBuyMenuOpen && !buyMenu.contains(e.target) && !buyButton.contains(e.target)) {
        toggleBuyMenu();
    }
    
    if (isSettingsMenuOpen && !settingsMenu.contains(e.target) && !settingsButton.contains(e.target)) {
        toggleSettingsMenu();
    }
    
    // Don't close search mode when clicking on search elements
    if (isSearchMode && !searchContainer.contains(e.target) && !searchButton.contains(e.target) && !searchBackBtn.contains(e.target)) {
        // Allow clicking on other elements while in search mode
    }
});
            
            const volumeSlider = document.querySelector('.volume-slider svg');
            volumeSlider.addEventListener('mousedown', startVolumeHanding);
            volumeSlider.addEventListener('touchstart', startVolumeHanding);
            volumeSlider.addEventListener('wheel', handleVolumeScroll, { passive: false });
            
            document.addEventListener('mousemove', continueVolumeHanding);
            document.addEventListener('mouseup', stopVolumeHanding);
            document.addEventListener('touchmove', continueVolumeHanding);
            document.addEventListener('touchend', stopVolumeHanding);
            
            
        });
        
        let hintTimer = null;
        let hasClickedAlbum = false;
        let menuTimer1 = null;
        let menuTimer2 = null;
        
        function showHints() {
            const hintOverlay = document.getElementById('hintOverlay');
            if (hintOverlay) {
                hintOverlay.classList.add('show');
                hintTimer = setTimeout(() => {
                    hintOverlay.classList.remove('show');
                }, 3000);
            }
        }
        
function showMenuHints() {
    const menuItems = document.querySelectorAll('.menu-item');
    
    // Enable hover effects for labels after 5 seconds
    menuItems.forEach(item => {
        const label = item.querySelector('.menu-label');
        if (label) {
            // Add hover event listeners
            item.addEventListener('mouseenter', () => {
                label.style.opacity = '1';
            });
            
            item.addEventListener('mouseleave', () => {
                label.style.opacity = '0';
            });
        }
    });
}
        
        function hideMenuHints() {
    // Clear all timers when menu closes
    if (menuTimer1) {
        clearTimeout(menuTimer1);
        menuTimer1 = null;
    }
    if (menuTimer2) {
        clearTimeout(menuTimer2);
        menuTimer2 = null;
    }
    
    // Remove hover event listeners and hide all labels
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        const label = item.querySelector('.menu-label');
        if (label) {
            label.style.opacity = '0';
            // Remove event listeners by cloning the element
            const newItem = item.cloneNode(true);
            item.parentNode.replaceChild(newItem, item);
        }
    });
}

function toggleSearchMode() {
    const phoneContainer = document.querySelector('.phone-container');
    const searchContainer = document.getElementById('searchContainer');
    const searchBackBtn = document.getElementById('searchMusicBtn');
    const floatingBubble = document.getElementById('floatingSongBubble');
    
    searchBackBtn.style.backgroundImage = `url('${tracks[currentTrack].albumArt}')`;
    const searchBtn = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    
    // Close any open menus first
    if (isBuyMenuOpen) {
        toggleBuyMenu();
    }
    if (isSettingsMenuOpen) {
        toggleSettingsMenu();
    }
    
    isSearchMode = true;
    
    // Add search mode styling
    phoneContainer.classList.add('search-mode');
    phoneContainer.classList.add('purple-effect');
    
    // Hide search button and show search container
    searchBtn.classList.add('collapsed');
    
    setTimeout(() => {
    searchContainer.classList.add('active');
    searchBackBtn.classList.add('active');
    searchBackBtn.style.backgroundImage = `url('${tracks[currentTrack].albumArt}')`;
    floatingBubble.classList.add('active');
    floatingBubble.textContent = `üéµ ${tracks[currentTrack].title} üéµ`;
    
    // Start the hint blinking every 5 seconds
    // Start the hint blinking every minute
// Start the hint blinking every minute
// First blink after 30 seconds, then stop moving
let hasBlinkHappened = false;
const blinkTimeout = setTimeout(() => {
    if (isSearchMode && !hasBlinkHappened) {
        hasBlinkHappened = true;
        
        // Smoothly transition to rest position
        floatingBubble.classList.add('resting');
        
        // Wait for smooth transition to complete, then blink
        setTimeout(() => {
            floatingBubble.classList.add('hint-blink');
            
            // Remove blink effect but keep resting
            setTimeout(() => {
                floatingBubble.classList.remove('hint-blink');
                // floatingBubble keeps 'resting' class - stays still forever
            }, 800);
        }, 2000); // Wait for 2s transition to complete
    }
}, 30000); // 30 seconds

// Store the timeout so we can clear it when exiting search mode
window.searchBlinkTimeout = blinkTimeout;
    
    // Focus on search input
    setTimeout(() => {
        searchInput.focus();
        searchInput.value = '';
    }, 200);
    
    phoneContainer.classList.remove('purple-effect');
}, 400);
}

let isNotesMode = false;

// Reset notes mode on page load/reload
window.addEventListener('load', () => {
    isNotesMode = false;
    const phoneContainer = document.querySelector('.phone-container');
    const notesContainer = document.getElementById('notesContainer');
    
    // Ensure clean state
    phoneContainer.classList.remove('notes-mode');
    if (notesContainer) {
        notesContainer.classList.remove('active');
    }
});

function toggleNotesMode() {
    const phoneContainer = document.querySelector('.phone-container');
    const notesContainer = document.getElementById('notesContainer');
    
    // Close any open menus first
    if (isBuyMenuOpen) {
        toggleBuyMenu();
    }
    if (isSettingsMenuOpen) {
        toggleSettingsMenu();
    }
    
    isNotesMode = true;
    
    // Add notes mode styling
    phoneContainer.classList.add('notes-mode');
    phoneContainer.classList.add('blue-effect');
    
    setTimeout(() => {
    notesContainer.classList.add('active');
    phoneContainer.classList.remove('blue-effect');
    loadNotesContent();
}, 400);
}

function exitNotesMode() {
    const phoneContainer = document.querySelector('.phone-container');
    const notesContainer = document.getElementById('notesContainer');
    
    isNotesMode = false;
    
    // Hide notes elements
    notesContainer.classList.remove('active');
    
    // Add exit effect
    phoneContainer.classList.add('purple-effect');
    
    setTimeout(() => {
        phoneContainer.classList.remove('notes-mode');
        phoneContainer.classList.remove('purple-effect');
    }, 400);
}
function loadNotesContent() {
    const notesContent = document.getElementById('notesContent');
    
    // Create the complete notes interface with all proper dropdowns
    notesContent.innerHTML = `
        <div style="display: flex; flex-direction: column; height: 100%; background: transparent; border-radius: 20px; overflow: hidden;">
            <!-- Dynamic Toolbar -->
            <div id="notesToolbar" style="display: flex; gap: 12px; padding: 20px 24px 16px 24px; background: transparent; border-bottom: 1px solid rgba(255, 255, 255, 0.15); flex-wrap: wrap; justify-content: center;">
                <!-- Drawing Tools -->
                <button id="penBtn" style="background: rgba(59, 130, 246, 0.4); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">‚úèÔ∏è Pen ‚ñº</button>
<button id="highlighterBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">üñçÔ∏è Highlighter ‚ñº</button>
                <button id="eraserBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">üßπ Eraser ‚ñº</button>
                <button id="lassoBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">ü™É Lasso</button>
                <button id="linesBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">üìè Lines</button>
                
                <!-- Formatting Tools -->
                <button id="fontBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; display: none;"><span id="currentFont">Arial</span> ‚ñº</button>
                <button id="sizeBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; display: none;"><span id="currentSize">14px</span> ‚ñº</button>
                <button id="boldBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; display: none; min-width: 40px;"><strong>B</strong></button>
                <button id="italicBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; display: none; min-width: 40px;"><em>I</em></button>
                <button id="underlineBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500; display: none; min-width: 40px;"><u>U</u></button>
                
                <!-- Universal Tools -->
                <button id="colorsBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">üé® Colors ‚ñº</button>
                <button id="exportBtn" style="background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white; padding: 12px 16px; cursor: pointer; font-size: 13px; font-weight: 500;">üìÑ Export</button>
            </div>
            
            <!-- Content Area -->
            <div id="contentArea" style="flex: 1; position: relative; background: transparent;">
                <canvas id="notesCanvas" style="width: 100%; height: 100%; display: block; touch-action: none; background: transparent;"></canvas>
            </div>

        <!-- Pen Stroke Dropdown -->
        <div id="penDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectPenStroke(1)">‚úèÔ∏è Thin (1px)</div>
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectPenStroke(2)">‚úèÔ∏è Normal (2px)</div>
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectPenStroke(4)">‚úèÔ∏è Medium (4px)</div>
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectPenStroke(6)">‚úèÔ∏è Thick (6px)</div>
        </div>

        <!-- Highlighter Stroke Dropdown -->
        <div id="highlighterDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectHighlighterStroke(4)">üñçÔ∏è Thin (4px)</div>
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectHighlighterStroke(8)">üñçÔ∏è Normal (8px)</div>
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectHighlighterStroke(12)">üñçÔ∏è Medium (12px)</div>
            <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="selectHighlighterStroke(16)">üñçÔ∏è Thick (16px)</div>
        </div>
            <!-- Tabs -->
            <div style="display: flex; justify-content: center; gap: 12px; padding: 16px 20px; background: transparent; border-top: 1px solid rgba(255, 255, 255, 0.15);">
                <button id="logicTab" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 10px 20px; color: rgba(255, 255, 255, 0.7); cursor: pointer; font-size: 13px; font-weight: 500;">‚ö° Logic</button>
                <button id="typedTab" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 10px 20px; color: rgba(255, 255, 255, 0.7); cursor: pointer; font-size: 13px; font-weight: 500;">üìù Typed</button>
                <button id="drawnTab" style="background: rgba(59, 130, 246, 0.4); border: 1px solid rgba(59, 130, 246, 0.6); border-radius: 20px; padding: 10px 20px; color: white; cursor: pointer; font-size: 13px; font-weight: 500;">üé® Drawn</button>
                <button id="coplayTab" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 10px 20px; color: rgba(255, 255, 255, 0.7); cursor: pointer; font-size: 13px; font-weight: 500;">ü§ù Coplay</button>
                <button id="machineTab" style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 10px 20px; color: rgba(255, 255, 255, 0.7); cursor: pointer; font-size: 13px; font-weight: 500;">ü§ñ Machine</button>
            </div>
        </div>
    `;
    
    // Add all the dropdowns to the body (outside the notes container)
    const dropdownsHTML = `
    <!-- Font Dropdown -->
    <div id="fontDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesFont('Arial')">Arial</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesFont('Times New Roman')">Times</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesFont('Helvetica')">Helvetica</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesFont('Georgia')">Georgia</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesFont('Verdana')">Verdana</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesFont('Courier New')">Courier</div>
    </div>

    <!-- Size Dropdown -->
    <div id="sizeDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('12')">12px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('14')">14px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('16')">16px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('18')">18px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('20')">20px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('24')">24px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('28')">28px</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesSize('32')">32px</div>
    </div>

    <!-- Colors Dropdown -->
    <div id="colorsDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px; margin-bottom: 8px;">
            <div class="color-swatch-dropdown active" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid #3b82f6; cursor: pointer; background-color: #000000; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#000000')" data-color="#000000"></div>
            <div class="color-swatch-dropdown" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid rgba(0, 0, 0, 0.2); cursor: pointer; background-color: #ef4444; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#ef4444')" data-color="#ef4444"></div>
            <div class="color-swatch-dropdown" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid rgba(0, 0, 0, 0.2); cursor: pointer; background-color: #22c55e; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#22c55e')" data-color="#22c55e"></div>
            <div class="color-swatch-dropdown" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid rgba(0, 0, 0, 0.2); cursor: pointer; background-color: #3b82f6; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#3b82f6')" data-color="#3b82f6"></div>
            <div class="color-swatch-dropdown" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid rgba(0, 0, 0, 0.2); cursor: pointer; background-color: #a855f7; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#a855f7')" data-color="#a855f7"></div>
            <div class="color-swatch-dropdown" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid rgba(0, 0, 0, 0.2); cursor: pointer; background-color: #f59e0b; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#f59e0b')" data-color="#f59e0b"></div>
            <div class="color-swatch-dropdown" style="width: 32px; height: 32px; border-radius: 8px; border: 2px solid rgba(0, 0, 0, 0.2); cursor: pointer; background-color: #ec4899; transition: all 0.2s ease;" onclick="event.stopPropagation(); selectNotesColor('#ec4899')" data-color="#ec4899"></div>
        </div>
        <div style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: rgba(0, 0, 0, 0.05); border-radius: 8px; margin: 0 8px 8px 8px;">
            <span style="color: #666; font-size: 12px;">#</span>
            <input type="text" id="hexInputDropdown" placeholder="000000" maxlength="6" style="background: transparent; border: none; color: #374151; font-size: 12px; width: 70px; outline: none; font-family: monospace;" oninput="handleNotesHexInput(this.value)">
        </div>
    </div>

    <!-- Eraser Dropdown -->
    <div id="eraserDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesEraserMode('brush')">üñåÔ∏è Brush</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectNotesEraserMode('object')">üéØ Object</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); clearNotesCanvas()">üóëÔ∏è Clear Canvas</div>
    </div>

    <!-- Pen Stroke Dropdown -->
    <div id="penDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectPenStroke(1)">‚úèÔ∏è Thin (1px)</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectPenStroke(2)">‚úèÔ∏è Normal (2px)</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectPenStroke(4)">‚úèÔ∏è Medium (4px)</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectPenStroke(6)">‚úèÔ∏è Thick (6px)</div>
    </div>

    <!-- Highlighter Stroke Dropdown -->
    <div id="highlighterDropdown" style="position: fixed; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; min-width: 120px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3); z-index: 999999; display: none;">
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectHighlighterStroke(4)">üñçÔ∏è Thin (4px)</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectHighlighterStroke(8)">üñçÔ∏è Normal (8px)</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectHighlighterStroke(12)">üñçÔ∏è Medium (12px)</div>
        <div class="dropdown-item" style="padding: 8px 16px; color: #374151; cursor: pointer; transition: all 0.2s ease; border-radius: 8px; margin: 4px;" onclick="event.stopPropagation(); selectHighlighterStroke(16)">üñçÔ∏è Thick (16px)</div>
    </div>
`;
    
    // Add dropdowns to document body
    document.body.insertAdjacentHTML('beforeend', dropdownsHTML);
    
    setTimeout(() => {
        initializeNotesApp();
    }, 50);
}

// Global variables
let notesCurrentTool = 'pen';
let notesCurrentColor = '#000000';
let notesCurrentTab = 'drawn';
let notesEraserMode = 'brush';
let notesIsDrawing = false;
let notesCanvas, notesCtx;

function initializeNotesApp() {
    console.log('Initializing notes app...');
    
    // Initialize canvas first
    initializeNotesCanvas();
    
    // Wait a bit for DOM to be fully ready, then attach events
    setTimeout(() => {
        attachNotesEventListeners();
        updateNotesToolbar();
        loadNotesSettings();
    }, 100);
}

function initializeNotesCanvas() {
    notesCanvas = document.getElementById('notesCanvas');
    if (notesCanvas) {
        const contentArea = document.getElementById('contentArea');
        const rect = contentArea.getBoundingClientRect();
        notesCanvas.width = rect.width;
        notesCanvas.height = rect.height;
        notesCtx = notesCanvas.getContext('2d');
        
        // Canvas drawing events
        notesCanvas.addEventListener('mousedown', startNotesDrawing);
        notesCanvas.addEventListener('mousemove', notesDrawing);
        notesCanvas.addEventListener('mouseup', stopNotesDrawing);
        notesCanvas.addEventListener('mouseout', stopNotesDrawing);
        
        // Touch events for mobile
        notesCanvas.addEventListener('touchstart', handleNotesTouchStart);
        notesCanvas.addEventListener('touchmove', handleNotesTouchMove);
        notesCanvas.addEventListener('touchend', stopNotesDrawing);
    }
}

function attachNotesEventListeners() {
    console.log('Attaching event listeners...');
    
    // Pen button - ALWAYS show dropdown when clicked
    const penBtn = document.getElementById('penBtn');
    if (penBtn) {
        penBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Pen button clicked - showing dropdown');
            toggleNotesPenDropdown(e);
        });
        console.log('Pen button listener attached');
    } else {
        console.error('Pen button not found!');
    }
    
    // Highlighter button - ALWAYS show dropdown when clicked
    const highlighterBtn = document.getElementById('highlighterBtn');
    if (highlighterBtn) {
        highlighterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Highlighter button clicked - showing dropdown');
            toggleNotesHighlighterDropdown(e);
        });
        console.log('Highlighter button listener attached');
    } else {
        console.error('Highlighter button not found!');
    }
    
    // Other toolbar buttons
    const eraserBtn = document.getElementById('eraserBtn');
    if (eraserBtn) {
        eraserBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleNotesEraserDropdown(e);
        });
    }
    
    const lassoBtn = document.getElementById('lassoBtn');
    if (lassoBtn) {
        lassoBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            setNotesTool('lasso');
        });
    }
    
    const linesBtn = document.getElementById('linesBtn');
    if (linesBtn) {
        linesBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleNotesLines();
        });
    }
    
    const colorsBtn = document.getElementById('colorsBtn');
    if (colorsBtn) {
        colorsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleNotesColorsDropdown(e);
        });
    }
    
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            exportNotesContent();
        });
    }
    
    // Formatting buttons
    const fontBtn = document.getElementById('fontBtn');
    if (fontBtn) {
        fontBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleNotesFontDropdown(e);
        });
    }
    
    const sizeBtn = document.getElementById('sizeBtn');
    if (sizeBtn) {
        sizeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleNotesSizeDropdown(e);
        });
    }
    
    // Tab buttons
    ['logicTab', 'typedTab', 'drawnTab', 'coplayTab', 'machineTab'].forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const tabName = tabId.replace('Tab', '');
                switchNotesTab(tabName);
            });
        }
    });
    
    // Global click handler to close dropdowns
    document.addEventListener('click', function(e) {
        // Check if click was inside any dropdown or button
        const isInsideDropdown = e.target.closest('#fontDropdown, #sizeDropdown, #colorsDropdown, #eraserDropdown, #penDropdown, #highlighterDropdown');
        const isDropdownButton = e.target.closest('#fontBtn, #sizeBtn, #colorsBtn, #eraserBtn, #penBtn, #highlighterBtn');
        
        if (!isInsideDropdown && !isDropdownButton) {
            closeAllNotesDropdowns();
        }
    });
    
    console.log('All event listeners attached');
}

function toggleNotesLines() {
    const modes = ['none', 'lines', 'grid'];
    const currentIndex = modes.indexOf(notesLinesMode);
    notesLinesMode = modes[(currentIndex + 1) % modes.length];
    
    const button = document.getElementById('linesBtn');
    if (button) {
        switch(notesLinesMode) {
            case 'none':
                button.innerHTML = 'üìè Lines';
                break;
            case 'lines':
                button.innerHTML = 'üìä Grid';
                break;
            case 'grid':
                button.innerHTML = '‚¨ú None';
                break;
        }
    }
    
    drawNotesLines();
    notesSettings.linesMode = notesLinesMode;
    saveNotesSettings();
    console.log('Lines mode changed to:', notesLinesMode);
}

function drawNotesLines() {
    if (!notesCanvas) return;
    
    // Create or get lines canvas
    let linesCanvas = document.getElementById('notesLinesCanvas');
    if (!linesCanvas) {
        linesCanvas = document.createElement('canvas');
        linesCanvas.id = 'notesLinesCanvas';
        linesCanvas.style.position = 'absolute';
        linesCanvas.style.top = '0';
        linesCanvas.style.left = '0';
        linesCanvas.style.pointerEvents = 'none';
        linesCanvas.style.zIndex = '1';
        linesCanvas.width = notesCanvas.width;
        linesCanvas.height = notesCanvas.height;
        notesCanvas.parentElement.insertBefore(linesCanvas, notesCanvas);
    }
    
    const linesCtx = linesCanvas.getContext('2d');
    linesCtx.clearRect(0, 0, linesCanvas.width, linesCanvas.height);
    
    if (notesLinesMode === 'none') return;
    
    linesCtx.strokeStyle = 'rgba(156, 163, 175, 0.3)';
    linesCtx.lineWidth = 1;
    
    const lineSpacing = 40;
    
    if (notesLinesMode === 'lines' || notesLinesMode === 'grid') {
        // Draw horizontal lines
        for (let y = lineSpacing; y < linesCanvas.height; y += lineSpacing) {
            linesCtx.beginPath();
            linesCtx.moveTo(0, y);
            linesCtx.lineTo(linesCanvas.width, y);
            linesCtx.stroke();
        }
    }
    
    if (notesLinesMode === 'grid') {
        // Draw vertical lines
        for (let x = lineSpacing; x < linesCanvas.width; x += lineSpacing) {
            linesCtx.beginPath();
            linesCtx.moveTo(x, 0);
            linesCtx.lineTo(x, linesCanvas.height);
            linesCtx.stroke();
        }
    }
}

function toggleNotesPenDropdown(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    console.log('toggleNotesPenDropdown called');
    
    const dropdown = document.getElementById('penDropdown');
    const button = document.getElementById('penBtn');
    
    if (!dropdown) {
        console.error('Pen dropdown not found!');
        return;
    }
    
    if (!button) {
        console.error('Pen button not found!');
        return;
    }
    
    // Close all other dropdowns first
    closeAllNotesDropdowns();
    
    // Set to pen tool
    setNotesTool('pen');
    
    // Toggle the dropdown
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
        console.log('Pen dropdown closed');
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
        dropdown.style.zIndex = '999999';
        console.log('Pen dropdown opened at:', rect.left, rect.bottom + 5);
    }
}

function toggleNotesHighlighterDropdown(e) {
    if (e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    console.log('toggleNotesHighlighterDropdown called');
    
    const dropdown = document.getElementById('highlighterDropdown');
    const button = document.getElementById('highlighterBtn');
    
    if (!dropdown) {
        console.error('Highlighter dropdown not found!');
        return;
    }
    
    if (!button) {
        console.error('Highlighter button not found!');
        return;
    }
    
    // Close all other dropdowns first
    closeAllNotesDropdowns();
    
    // Set to highlighter tool
    setNotesTool('highlighter');
    
    // Toggle the dropdown
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
        console.log('Highlighter dropdown closed');
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
        dropdown.style.zIndex = '999999';
        console.log('Highlighter dropdown opened at:', rect.left, rect.bottom + 5);
    }
}

function handleNotesTouchStart(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    startNotesDrawing(mouseEvent);
}

function handleNotesTouchMove(e) {
    e.preventDefault();
    const touch = e.touches[0];
    const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
    });
    notesDrawing(mouseEvent);
}

function closeAllNotesDropdowns() {
    ['fontDropdown', 'sizeDropdown', 'colorsDropdown', 'eraserDropdown', 'penDropdown', 'highlighterDropdown'].forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown) {
            dropdown.style.display = 'none';
        }
    });
}

function toggleNotesHighlighterDropdown(e) {
    if (e) e.stopPropagation();
    const dropdown = document.getElementById('highlighterDropdown');
    const button = document.getElementById('highlighterBtn');
    closeAllNotesDropdowns();
    
    // Always set to highlighter tool when opening dropdown
    setNotesTool('highlighter');
    
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
    }
}

function toggleNotesColorsDropdown(e) {
    if (e) e.stopPropagation();
    const dropdown = document.getElementById('colorsDropdown');
    const button = document.getElementById('colorsBtn');
    closeAllNotesDropdowns();
    
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
    }
}

function toggleNotesEraserDropdown(e) {
    if (e) e.stopPropagation();
    const dropdown = document.getElementById('eraserDropdown');
    const button = document.getElementById('eraserBtn');
    closeAllNotesDropdowns();
    
    // Set eraser tool when opening dropdown
    setNotesTool('eraser');
    
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
    }
}

function toggleNotesFontDropdown(e) {
    if (e) e.stopPropagation();
    const dropdown = document.getElementById('fontDropdown');
    const button = document.getElementById('fontBtn');
    closeAllNotesDropdowns();
    
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
    }
}

function toggleNotesSizeDropdown(e) {
    if (e) e.stopPropagation();
    const dropdown = document.getElementById('sizeDropdown');
    const button = document.getElementById('sizeBtn');
    closeAllNotesDropdowns();
    
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        const rect = button.getBoundingClientRect();
        dropdown.style.left = rect.left + 'px';
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.display = 'block';
    }
}

function selectPenStroke(size) {
    event.stopPropagation();
    notesPenStroke = size;
    notesSettings.penStroke = size;
    document.getElementById('penDropdown').style.display = 'none';
    saveNotesSettings();
    console.log('Pen stroke size changed to:', size);
}

function selectHighlighterStroke(size) {
    event.stopPropagation();
    notesHighlighterStroke = size;
    notesSettings.highlighterStroke = size;
    document.getElementById('highlighterDropdown').style.display = 'none';
    saveNotesSettings();
    console.log('Highlighter stroke size changed to:', size);
}

function selectNotesFont(fontName) {
    event.stopPropagation();
    document.getElementById('currentFont').textContent = fontName;
    document.getElementById('fontDropdown').style.display = 'none';
    notesSettings.currentFont = fontName;
    saveNotesSettings();
    console.log('Font changed to:', fontName);
}

function selectNotesSize(size) {
    event.stopPropagation();
    document.getElementById('currentSize').textContent = size + 'px';
    document.getElementById('sizeDropdown').style.display = 'none';
    notesSettings.currentSize = size;
    saveNotesSettings();
    console.log('Size changed to:', size);
}

function selectNotesColor(color) {
    event.stopPropagation();
    notesCurrentColor = color;
    notesSettings.currentColor = color;
    document.getElementById('colorsDropdown').style.display = 'none';
    updateNotesHexInput();
    
    // Update active state
    document.querySelectorAll('.color-swatch-dropdown').forEach(swatch => {
        swatch.classList.remove('active');
        swatch.style.border = '2px solid rgba(0, 0, 0, 0.2)';
    });
    document.querySelector(`[data-color="${color}"]`).style.border = '2px solid #3b82f6';
    document.querySelector(`[data-color="${color}"]`).classList.add('active');
    
    saveNotesSettings();
    console.log('Color changed to:', color);
}

function selectNotesEraserMode(mode) {
    event.stopPropagation();
    notesEraserMode = mode;
    notesSettings.eraserMode = mode;
    document.getElementById('eraserDropdown').style.display = 'none';
    saveNotesSettings();
    console.log('Eraser mode:', mode);
}

function clearNotesCanvas() {
    event.stopPropagation();
    if (notesCtx) {
        notesCtx.clearRect(0, 0, notesCanvas.width, notesCanvas.height);
    }
    document.getElementById('eraserDropdown').style.display = 'none';
    saveNotesSettings();
}

function handleNotesHexInput(value) {
    const cleanValue = value.replace(/[^0-9a-fA-F]/g, '').substring(0, 6);
    const hexInput = document.getElementById('hexInputDropdown');
    
    if (hexInput) {
        hexInput.value = cleanValue;
    }
    
    if (cleanValue.length === 6) {
        const hexColor = '#' + cleanValue;
        selectNotesColor(hexColor);
    }
}

function updateNotesHexInput() {
    const hexInput = document.getElementById('hexInputDropdown');
    if (hexInput) {
        hexInput.value = notesCurrentColor.replace('#', '');
    }
}


function exportNotesContent() {
    if (notesCanvas) {
        const link = document.createElement('a');
        link.download = 'notes-export.png';
        link.href = notesCanvas.toDataURL();
        link.click();
    }
}

// Drawing functions
function startNotesDrawing(e) {
    if (notesCurrentTab !== 'drawn') return;
    
    const rect = notesCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const pos = { x, y };
    
    // Handle lasso tool
    if (notesCurrentTool === 'lasso') {
        if (notesSelectedStrokes.length > 0 && isPointInNotesSelection(pos)) {
            // Start dragging selected strokes
            notesIsDragging = true;
            notesDragOffset = pos;
            return;
        } else {
            // Start new lasso selection
            clearNotesSelection();
            notesLassoPath = [pos];
            notesIsDrawing = true;
            return;
        }
    }
    
    if (notesCurrentTool !== 'pen' && notesCurrentTool !== 'highlighter' && notesCurrentTool !== 'eraser') return;
    
    notesIsDrawing = true;
    
    // Start new stroke for tracking
    notesCurrentStroke = {
        tool: notesCurrentTool,
        color: notesCurrentColor,
        points: [pos],
        lineWidth: getNotesLineWidth()
    };
    
    notesCtx.beginPath();
    notesCtx.moveTo(x, y);
    setupNotesDrawingContext();
    
    // Draw initial point
    notesCtx.beginPath();
    notesCtx.arc(x, y, notesCtx.lineWidth / 2, 0, 2 * Math.PI);
    notesCtx.fill();
    notesCtx.beginPath();
    notesCtx.moveTo(x, y);
}

function notesDrawing(e) {
    if (notesCurrentTab !== 'drawn') return;
    
    const rect = notesCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const pos = { x, y };
    
    // Handle lasso selection
    if (notesCurrentTool === 'lasso' && notesIsDrawing) {
        notesLassoPath.push(pos);
        drawNotesLassoPath();
        return;
    }
    
    // Handle dragging selected strokes
    if (notesCurrentTool === 'lasso' && notesIsDragging) {
        const deltaX = pos.x - notesDragOffset.x;
        const deltaY = pos.y - notesDragOffset.y;
        moveNotesSelectedStrokes(deltaX, deltaY);
        notesDragOffset = pos;
        return;
    }
    
    if (!notesIsDrawing || (notesCurrentTool !== 'pen' && notesCurrentTool !== 'highlighter' && notesCurrentTool !== 'eraser')) return;
    
    // Add point to current stroke
    if (notesCurrentStroke) {
        notesCurrentStroke.points.push(pos);
    }
    
    notesCtx.lineTo(x, y);
    notesCtx.stroke();
    notesCtx.beginPath();
    notesCtx.moveTo(x, y);
}

function stopNotesDrawing() {
    if (notesCurrentTool === 'lasso') {
        if (notesIsDrawing) {
            // Complete lasso selection
            completeNotesLassoSelection();
        }
        notesIsDragging = false;
        notesIsDrawing = false;
        return;
    }
    
    if (notesIsDrawing) {
        notesIsDrawing = false;
        notesCtx.beginPath();
        
        // Save completed stroke
        if (notesCurrentStroke && notesCurrentStroke.points.length > 0) {
            notesStrokes.push(notesCurrentStroke);
            notesCurrentStroke = null;
        }
        
        // Auto-save after drawing
        setTimeout(saveNotesSettings, 500);
    }
}

function getNotesLineWidth() {
    switch(notesCurrentTool) {
        case 'pen': return notesPenStroke;
        case 'highlighter': return notesHighlighterStroke;
        case 'eraser': return 20;
        default: return 2;
    }
}

function drawNotesLassoPath() {
    if (!notesCtx || !notesLassoPath || notesLassoPath.length < 2) return;
    
    // Clear and redraw canvas
    redrawNotesCanvas();
    
    // Draw lasso path
    notesCtx.strokeStyle = '#3b82f6';
    notesCtx.lineWidth = 2;
    notesCtx.setLineDash([5, 5]);
    notesCtx.globalCompositeOperation = 'source-over';
    notesCtx.globalAlpha = 1;
    
    notesCtx.beginPath();
    notesCtx.moveTo(notesLassoPath[0].x, notesLassoPath[0].y);
    
    for (let i = 1; i < notesLassoPath.length; i++) {
        notesCtx.lineTo(notesLassoPath[i].x, notesLassoPath[i].y);
    }
    
    notesCtx.stroke();
    notesCtx.setLineDash([]);
}

function completeNotesLassoSelection() {
    if (notesLassoPath.length < 3) {
        notesLassoPath = [];
        redrawNotesCanvas();
        return;
    }
    
    // Find strokes inside lasso
    notesSelectedStrokes = [];
    
    notesStrokes.forEach((stroke, index) => {
        if (isNotesStrokeInLasso(stroke)) {
            notesSelectedStrokes.push(index);
        }
    });
    
    notesLassoPath = [];
    redrawNotesCanvas();
    drawNotesSelection();
}

function isNotesStrokeInLasso(stroke) {
    if (!stroke || !stroke.points || !notesLassoPath || notesLassoPath.length < 3) return false;
    return stroke.points.some(point => isPointInPolygon(point, notesLassoPath));
}

function isPointInPolygon(point, polygon) {
    if (!point || !polygon || polygon.length < 3) return false;
    
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        if (((polygon[i].y > point.y) !== (polygon[j].y > point.y)) &&
            (point.x < (polygon[j].x - polygon[i].x) * (point.y - polygon[i].y) / (polygon[j].y - polygon[i].y) + polygon[i].x)) {
            inside = !inside;
        }
    }
    return inside;
}

function isPointInNotesSelection(point) {
    if (!point || !notesSelectedStrokes || notesSelectedStrokes.length === 0) return false;
    
    return notesSelectedStrokes.some(strokeIndex => {
        const stroke = notesStrokes[strokeIndex];
        return stroke && isPointNearStroke(point.x, point.y, stroke);
    });
}

function isPointNearStroke(x, y, stroke) {
    if (!stroke || !stroke.points || !stroke.lineWidth) return false;
    
    const tolerance = Math.max(stroke.lineWidth, 10);
    
    for (let i = 0; i < stroke.points.length - 1; i++) {
        const p1 = stroke.points[i];
        const p2 = stroke.points[i + 1];
        
        const distance = distanceToLineSegment(x, y, p1.x, p1.y, p2.x, p2.y);
        if (distance <= tolerance) {
            return true;
        }
    }
    
    return false;
}

function distanceToLineSegment(px, py, x1, y1, x2, y2) {
    const A = px - x1;
    const B = py - y1;
    const C = x2 - x1;
    const D = y2 - y1;
    
    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    
    if (lenSq === 0) return Math.sqrt(A * A + B * B);
    
    let param = dot / lenSq;
    
    if (param < 0) {
        return Math.sqrt(A * A + B * B);
    } else if (param > 1) {
        const E = px - x2;
        const F = py - y2;
        return Math.sqrt(E * E + F * F);
    } else {
        const projX = x1 + param * C;
        const projY = y1 + param * D;
        const G = px - projX;
        const H = py - projY;
        return Math.sqrt(G * G + H * H);
    }
}

function moveNotesSelectedStrokes(deltaX, deltaY) {
    if (!notesSelectedStrokes || notesSelectedStrokes.length === 0) return;
    
    notesSelectedStrokes.forEach(strokeIndex => {
        const stroke = notesStrokes[strokeIndex];
        if (stroke && stroke.points) {
            stroke.points.forEach(point => {
                point.x += deltaX;
                point.y += deltaY;
            });
        }
    });
    
    redrawNotesCanvas();
    drawNotesSelection();
}

function drawNotesSelection() {
    if (!notesSelectedStrokes || notesSelectedStrokes.length === 0 || !notesCtx) return;
    
    // Find bounding box of selected strokes
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    
    notesSelectedStrokes.forEach(strokeIndex => {
        const stroke = notesStrokes[strokeIndex];
        if (stroke && stroke.points) {
            stroke.points.forEach(point => {
                minX = Math.min(minX, point.x);
                minY = Math.min(minY, point.y);
                maxX = Math.max(maxX, point.x);
                maxY = Math.max(maxY, point.y);
            });
        }
    });
    
    // Draw selection box
    notesCtx.strokeStyle = '#3b82f6';
    notesCtx.lineWidth = 2;
    notesCtx.setLineDash([5, 5]);
    notesCtx.globalCompositeOperation = 'source-over';
    notesCtx.globalAlpha = 1;
    
    notesCtx.strokeRect(minX - 10, minY - 10, maxX - minX + 20, maxY - minY + 20);
    notesCtx.setLineDash([]);
}

function clearNotesSelection() {
    notesSelectedStrokes = [];
    notesLassoPath = [];
    if (notesCanvas && notesCtx) {
        redrawNotesCanvas();
    }
}

function redrawNotesCanvas() {
    if (!notesCanvas || !notesCtx) return;
    
    // Clear canvas
    notesCtx.clearRect(0, 0, notesCanvas.width, notesCanvas.height);
    
    // Redraw all strokes
    notesStrokes.forEach(stroke => {
        redrawNotesStroke(stroke);
    });
}

function redrawNotesStroke(stroke) {
    if (!stroke || !stroke.points || stroke.points.length === 0 || !notesCtx) return;
    
    notesCtx.beginPath();
    notesCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
    
    setupNotesStrokeContext(stroke);
    
    for (let i = 1; i < stroke.points.length; i++) {
        notesCtx.lineTo(stroke.points[i].x, stroke.points[i].y);
    }
    
    notesCtx.stroke();
    notesCtx.globalAlpha = 1;
}

function setupNotesStrokeContext(stroke) {
    if (!notesCtx || !stroke) return;
    
    if (stroke.tool === 'pen') {
        notesCtx.globalCompositeOperation = 'source-over';
        notesCtx.strokeStyle = stroke.color;
        notesCtx.globalAlpha = 1;
    } else if (stroke.tool === 'highlighter') {
        notesCtx.globalCompositeOperation = 'multiply';
        notesCtx.strokeStyle = stroke.color;
        notesCtx.globalAlpha = 0.4;
    } else if (stroke.tool === 'eraser') {
        notesCtx.globalCompositeOperation = 'destination-out';
        notesCtx.globalAlpha = 1;
    }
    
    notesCtx.lineWidth = stroke.lineWidth || 2;
    notesCtx.lineCap = 'round';
    notesCtx.lineJoin = 'round';
}

function setupNotesDrawingContext() {
    if (notesCurrentTool === 'pen') {
        notesCtx.globalCompositeOperation = 'source-over';
        notesCtx.strokeStyle = notesCurrentColor;
        notesCtx.lineWidth = notesPenStroke;
        notesCtx.globalAlpha = 1;
    } else if (notesCurrentTool === 'highlighter') {
        notesCtx.globalCompositeOperation = 'multiply';
        notesCtx.strokeStyle = notesCurrentColor;
        notesCtx.lineWidth = notesHighlighterStroke;
        notesCtx.globalAlpha = 0.4;
    } else if (notesCurrentTool === 'eraser') {
        notesCtx.globalCompositeOperation = 'destination-out';
        notesCtx.lineWidth = 20;
        notesCtx.globalAlpha = 1;
    }
    notesCtx.lineCap = 'round';
    notesCtx.lineJoin = 'round';
}

function setNotesTool(tool) {
    notesCurrentTool = tool;
    updateNotesToolButtons();
    notesSettings.currentTool = tool;
    saveNotesSettings();
    console.log('Tool changed to:', tool);
}

function updateNotesToolButtons() {
    ['penBtn', 'highlighterBtn', 'eraserBtn', 'lassoBtn'].forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            const toolName = id.replace('Btn', '');
            if (toolName === notesCurrentTool) {
                btn.style.background = 'rgba(59, 130, 246, 0.4)';
                btn.style.borderColor = 'rgba(59, 130, 246, 0.6)';
            } else {
                btn.style.background = 'rgba(255, 255, 255, 0.15)';
                btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            }
        }
    });
}

function switchNotesTab(tab) {
    notesCurrentTab = tab;
    updateNotesToolbar();
    updateNotesTabButtons(tab);
    updateNotesContent(tab);
    console.log('Switched to tab:', tab);
}

function updateNotesToolbar() {
    const toolbar = document.getElementById('notesToolbar');
    
    if (notesCurrentTab === 'logic' || notesCurrentTab === 'machine') {
        toolbar.style.display = 'none';
        return;
    }
    
    toolbar.style.display = 'flex';
    
    const drawingTools = ['penBtn', 'highlighterBtn', 'eraserBtn', 'lassoBtn', 'linesBtn'];
    const formattingTools = ['fontBtn', 'sizeBtn', 'boldBtn', 'italicBtn', 'underlineBtn'];
    
    drawingTools.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = (notesCurrentTab === 'drawn' || notesCurrentTab === 'coplay') ? 'block' : 'none';
    });
    
    formattingTools.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = (notesCurrentTab === 'typed') ? 'block' : 'none';
    });
}

function updateNotesTabButtons(activeTab) {
    ['logicTab', 'typedTab', 'drawnTab', 'coplayTab', 'machineTab'].forEach(id => {
        const btn = document.getElementById(id);
        if (id === activeTab + 'Tab') {
            btn.style.background = 'rgba(59, 130, 246, 0.4)';
            btn.style.borderColor = 'rgba(59, 130, 246, 0.6)';
            btn.style.color = 'white';
        } else {
            btn.style.background = 'rgba(255, 255, 255, 0.1)';
            btn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
            btn.style.color = 'rgba(255, 255, 255, 0.7)';
        }
    });
}

function updateNotesContent(tab) {
    const contentArea = document.getElementById('contentArea');
    
    if (tab === 'drawn') {
    contentArea.innerHTML = '<canvas id="notesCanvas" style="width: 100%; height: 100%; display: block; touch-action: none; background: transparent;"></canvas>';
    setTimeout(() => {
        notesCanvas = document.getElementById('notesCanvas');
        if (notesCanvas) {
            const rect = contentArea.getBoundingClientRect();
            notesCanvas.width = rect.width;
            notesCanvas.height = rect.height;
            notesCtx = notesCanvas.getContext('2d');
            
            notesCanvas.addEventListener('mousedown', startNotesDrawing);
            notesCanvas.addEventListener('mousemove', notesDrawing);
            notesCanvas.addEventListener('mouseup', stopNotesDrawing);
            notesCanvas.addEventListener('mouseout', stopNotesDrawing);
            
            // Initialize lines
            drawNotesLines();
            
            // Redraw any existing strokes
            if (notesStrokes.length > 0) {
                redrawNotesCanvas();
            }
        }
    }, 50);
}
    
    else if (tab === 'typed') {
        contentArea.innerHTML = '<div style="width: 100%; height: 100%; padding: 20px; color: white; font-size: 14px;"><div contenteditable="true" style="width: 100%; height: 100%; outline: none; background: transparent;" placeholder="Start typing...">Start typing your notes here...</div></div>';
    } else {
        const sectionNames = { 
            logic: { icon: '‚ö°', name: 'Logic' }, 
            coplay: { icon: 'ü§ù', name: 'Coplay' }, 
            machine: { icon: 'ü§ñ', name: 'Machine' } 
        };
        const section = sectionNames[tab];
        contentArea.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255, 255, 255, 0.7);"><div style="text-align: center;"><div style="font-size: 48px; margin-bottom: 16px;">${section.icon}</div><div>${section.name} section coming soon...</div></div></div>`;
    }
}

function exitSearchMode() {
    const phoneContainer = document.querySelector('.phone-container');
    const searchContainer = document.getElementById('searchContainer');
    const searchBackBtn = document.getElementById('searchMusicBtn');
    const floatingBubble = document.getElementById('floatingSongBubble');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    
    isSearchMode = false;
    
    // Hide search elements
searchContainer.classList.remove('active');
searchBackBtn.classList.remove('active');
floatingBubble.classList.remove('active');
searchResults.style.display = 'none';
    
    // Add exit effect
    phoneContainer.classList.add('blue-effect');
    
    setTimeout(() => {
        phoneContainer.classList.remove('search-mode');
        searchBtn.classList.remove('collapsed');
        phoneContainer.classList.remove('blue-effect');
    }, 400);

    // Clear the blink timeout when exiting search mode
if (window.searchBlinkTimeout) {
    clearTimeout(window.searchBlinkTimeout);
    window.searchBlinkTimeout = null;
}
}

function handleSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const query = searchInput.value.trim().toLowerCase();
    
    if (query.length === 0) {
        searchResults.style.display = 'none';
        return;
    }
    
    // Mock search results for now
    const mockResults = [
        { title: "Track: Ocean Waves", type: "Music", description: "Relaxing ocean sounds for meditation" },
        { title: "Playlist: Chill Vibes", type: "Playlist", description: "Perfect for relaxing moments" },
        { title: "Artist: Cosmic Flow", type: "Artist", description: "Electronic ambient music producer" },
        { title: "Album: Digital Rain", type: "Album", description: "Futuristic soundscapes collection" }
    ].filter(item => 
        item.title.toLowerCase().includes(query) ||
        item.description.toLowerCase().includes(query)
    );
    
    if (mockResults.length > 0) {
        searchResults.innerHTML = mockResults.map(result => `
            <div class="search-result-item" onclick="selectSearchResult('${result.title}', '${result.type}')">
                <div style="font-weight: 600; margin-bottom: 5px;">${result.title}</div>
                <div style="font-size: 12px; opacity: 0.8;">${result.description}</div>
            </div>
        `).join('');
        searchResults.style.display = 'block';
    } else {
        searchResults.innerHTML = `
            <div class="search-result-item">
                <div style="text-align: center; opacity: 0.6;">No results found for "${query}"</div>
            </div>
        `;
        searchResults.style.display = 'block';
    }
}

function selectSearchResult(title, type) {
    console.log(`Selected ${type}: ${title}`);
    
    const phoneContainer = document.querySelector('.phone-container');
    phoneContainer.classList.add('purchase-effect');
    
    setTimeout(() => {
        phoneContainer.classList.remove('purchase-effect');
        exitSearchMode();
    }, 800);
}

function handleSongTitleClick() {
    if (isSearchMode) {
        exitSearchMode();
    } else {
        changeGreetingText();
    }
}

function setupMobileSwipe() {
    const phoneContainer = document.querySelector('.phone-container');
    
    phoneContainer.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
        currentY = startY;
        isDragging = false;
    }, { passive: true });
    
    phoneContainer.addEventListener('touchmove', function(e) {
        if (!startY) return;
        
        currentY = e.touches[0].clientY;
        const diffY = startY - currentY;
        
        // Only allow upward swipes
        if (diffY > 10) {
            isDragging = true;
            
            // Visual feedback - slightly scale down container
            const progress = Math.min(diffY / swipeThreshold, 1);
            const scale = 1 - (progress * 0.05);
            const opacity = 1 - (progress * 0.3);
            
            phoneContainer.style.transform = `scale(${scale})`;
            phoneContainer.style.opacity = opacity;
        }
    }, { passive: true });
    
    phoneContainer.addEventListener('touchend', function(e) {
        if (!startY) return;
        
        const diffY = startY - currentY;
        
        // Reset visual state
        phoneContainer.style.transform = '';
        phoneContainer.style.opacity = '';
        
        // If swiped up enough, dismiss settings first, then blob
if (diffY > swipeThreshold && isDragging) {
    // Check if notes mode is active first - dismiss entire blob
    if (isNotesMode) {
        dismissBlob();
    }
    // Check if settings menu is open first
    else if (isSettingsMenuOpen) {
        toggleSettingsMenu();
    } else if (isBuyMenuOpen) {
        toggleBuyMenu();
    } else {
        dismissBlob();
    }
}
        
        startY = 0;
        currentY = 0;
        isDragging = false;
    }, { passive: true });
}

function addMobileSwipeIndicator() {
    const indicator = document.createElement('div');
    indicator.className = 'mobile-swipe-indicator';
    document.body.appendChild(indicator);
    
    // Hide indicator after 5 seconds
    setTimeout(() => {
        indicator.style.opacity = '0';
        setTimeout(() => {
            if (indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }, 1000);
    }, 5000);
}

function dismissBlob() {
    console.log('Dismissing blob via swipe up');
    
    // Add exit animation
    const phoneContainer = document.querySelector('.phone-container');
    phoneContainer.style.transform = 'translateY(-100vh)';
    phoneContainer.style.opacity = '0';
    phoneContainer.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
    
    // Send dismiss message to parent
    setTimeout(() => {
        // Reset all styles before dismissing to prevent empty blob on next open
        phoneContainer.style.transform = '';
        phoneContainer.style.opacity = '';
        phoneContainer.style.transition = '';
        
        // Reset any active states
        if (isNotesMode) {
            exitNotesMode();
            isNotesMode = false; // Ensure it's fully reset
        }
        if (isSearchMode) {
            exitSearchMode();
        }
        if (isBuyMenuOpen) {
            toggleBuyMenu();
        }
        if (isSettingsMenuOpen) {
            toggleSettingsMenu();
        }
        
        window.parent.postMessage({ action: 'dismissOverlay' }, '*');
    }, 300);
}



// Close all dropdowns function
function closeAllNotesDropdowns() {
    ['fontDropdown', 'sizeDropdown', 'colorsDropdown', 'eraserDropdown', 'penDropdown', 'highlighterDropdown'].forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown) dropdown.style.display = 'none';
    });
}

// Persistence functions
function saveNotesSettings() {
    try {
        // Save current settings
        notesSettings.currentColor = notesCurrentColor;
        notesSettings.currentTool = notesCurrentTool;
        notesSettings.lastTab = notesCurrentTab;
        
        localStorage.setItem('chimos_notes_settings', JSON.stringify(notesSettings));
        
        // Save current drawing if on drawn tab
        if (notesCurrentTab === 'drawn' && notesCanvas) {
            const drawingData = {
                imageData: notesCanvas.toDataURL(),
                timestamp: Date.now()
            };
            localStorage.setItem('chimos_notes_drawing', JSON.stringify(drawingData));
        }
        
        console.log('Notes settings saved');
    } catch (error) {
        console.warn('Could not save notes settings:', error);
    }
}

function loadNotesSettings() {
    try {
        const savedSettings = localStorage.getItem('chimos_notes_settings');
        if (savedSettings) {
            notesSettings = { ...notesSettings, ...JSON.parse(savedSettings) };
            
            // Apply loaded settings
            notesCurrentColor = notesSettings.currentColor;
            notesCurrentTool = notesSettings.currentTool;
            notesCurrentTab = notesSettings.lastTab;
            notesPenStroke = notesSettings.penStroke;
            notesHighlighterStroke = notesSettings.highlighterStroke;
            
            // Update UI to reflect loaded settings
            updateNotesToolButtons();
            updateNotesTabButtons(notesCurrentTab);
            
            console.log('Notes settings loaded');
        }
        
        // Load saved drawing
        const savedDrawing = localStorage.getItem('chimos_notes_drawing');
        if (savedDrawing && notesCurrentTab === 'drawn') {
            const drawingData = JSON.parse(savedDrawing);
            setTimeout(() => restoreNotesDrawing(drawingData.imageData), 100);
        }
        
    } catch (error) {
        console.warn('Could not load notes settings:', error);
    }
}

function restoreNotesDrawing(imageData) {
    if (notesCanvas && notesCtx && imageData) {
        const img = new Image();
        img.onload = function() {
            notesCtx.clearRect(0, 0, notesCanvas.width, notesCanvas.height);
            notesCtx.drawImage(img, 0, 0);
            console.log('Drawing restored');
        };
        img.src = imageData;
    }
}
// Update mobile detection on resize
window.addEventListener('resize', () => {
    isMobile = window.innerWidth <= 768;
});
// Handle empty space clicks on mobile to dismiss blob
document.addEventListener('click', function(e) {
    if (window.innerWidth <= 768) {
        // Check if click is NOT on any interactive element
        const isOnApp = e.target.closest('.app');
        const isOnButton = e.target.closest('button');
        const isOnMenu = e.target.closest('.settings-menu-dropdown, .buy-menu-dropdown');
        const isOnMediaPlayer = e.target.closest('.media-player');
        const isOnSlider = e.target.closest('.progress-slider, .volume-slider');
        const isOnSearchContainer = e.target.closest('.search-container');
        const isOnFloatingBubble = e.target.closest('.floating-song-bubble');
        const isOnInput = e.target.closest('input, textarea');
        
        // If click is NOT on any interactive element, it's empty space
        if (!isOnApp && !isOnButton && !isOnMenu && !isOnMediaPlayer && 
            !isOnSlider && !isOnSearchContainer && !isOnFloatingBubble && !isOnInput) {
            
            console.log('Empty space clicked on mobile'); // Debug log
            window.parent.postMessage({ action: 'clickedEmptySpace' }, '*');
        }
    }
});
    </script>
</body>
</html>